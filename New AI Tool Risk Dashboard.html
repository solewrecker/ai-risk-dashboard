<script>
    // Global variables
    let processedData = [];

    // --- Main Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        // IMPORTANT: Replace with your actual Supabase project URL and Anon Key
        const SUPABASE_URL = "YOUR_SUPABASE_URL";
        const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

        if (SUPABASE_URL.includes("YOUR_SUPABASE_URL")) {
            alert('Please replace YOUR_SUPABASE_URL and YOUR_SUPABASE_ANON_KEY in the script inside New AI Tool Risk Dashboard.html');
        }

        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Admin Role Check ---
        let isAdmin = false;
        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                isAdmin = session.user?.user_metadata?.role === 'admin';
            }
        } catch (error) {
            console.error("Error checking admin status:", error);
        }


        // Only show import button to admins
        const importContainer = document.getElementById('importContainer');
        if (importContainer) {
            importContainer.style.display = isAdmin ? 'inline-block' : 'none';
        }

        // --- Setup Event Listeners ---
        const importBtn = document.getElementById('importBtn');
        const importModal = document.getElementById('importModal');
        const closeBtn = document.querySelector('.modal-content .close');

        if (importBtn) {
            importBtn.onclick = () => {
                importModal.style.display = 'block';
            };
        }
        if (closeBtn) {
            closeBtn.onclick = () => {
                importModal.style.display = 'none';
            };
        }
        window.onclick = (event) => {
            if (event.target == importModal) {
                importModal.style.display = 'none';
            }
        };

        // Initial data load
        loadDataFromDB();
    });

    // --- Database and UI Functions ---
    async function loadDataFromDB() {
        const SUPABASE_URL = "YOUR_SUPABASE_URL";
        const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        try {
            const { data, error } = await supabase
                .from('ai_tools')
                .select('*')
                .order('total_score', { ascending: false });

            if (error) {
                console.error("Error fetching data:", error);
                alert('Error fetching data from the database. See console for details.');
                return;
            }

            processedData = data.map(tool => {
                // Ensure detailed_assessment is parsed if it's a string
                if (typeof tool.detailed_assessment === 'string') {
                    try {
                        tool.detailed_assessment = JSON.parse(tool.detailed_assessment);
                    } catch (e) {
                        console.error('Failed to parse detailed_assessment for tool:', tool.name, e);
                        tool.detailed_assessment = {}; // Fallback to an empty object
                    }
                }
                // Handle cases where detailed_assessment might be null
                if (!tool.detailed_assessment) {
                    tool.detailed_assessment = {};
                }
                return tool;
            });
            populateGrid();

        } catch (err) {
            console.error('An unexpected error occurred:', err);
            alert('An unexpected error occurred. Check the console.');
        }
    }


    function populateGrid() {
        const grid = document.getElementById('toolGrid');
        grid.innerHTML = ''; // Clear existing cards

        processedData.forEach(tool => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <h3>${tool.name}</h3>
                    <div class="card-actions">
                        <button class="btn-icon" onclick='showDetails(${JSON.stringify(tool)})'><i class="fas fa-info-circle"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="risk-score" style="color: ${getRiskColor(tool.risk_level)};">
                        ${tool.total_score} - ${tool.risk_level}
                    </div>
                    <div class="card-meta">
                        <span><strong>Vendor:</strong> ${tool.vendor}</span>
                        <span><strong>Category:</strong> ${tool.category}</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function getRiskColor(riskLevel) {
        if (!riskLevel) return '#6c757d';
        const level = riskLevel.toUpperCase();
        if (level.includes('CRITICAL')) return '#dc3545';
        if (level.includes('HIGH')) return '#fd7e14';
        if (level.includes('MEDIUM')) return '#ffc107';
        if (level.includes('LOW')) return '#198754';
        return '#6c757d'; // Default color
    }

    function showDetails(tool) {
        const modal = document.getElementById('detailsModal');
        const content = document.getElementById('detailsContent');

        // This is a fallback mechanism. The primary data comes from `tool.detailed_assessment`.
        const assessment = tool.detailed_assessment || generateAssessmentFromLegacy(tool);

        let html = `
            <h2>${tool.name}</h2>
            <p><strong>Vendor:</strong> ${tool.vendor} | <strong>Category:</strong> ${tool.category}</p>
            <hr>
            <h4>Overall Risk: <span style="color:${getRiskColor(tool.risk_level)};">${tool.total_score} - ${tool.risk_level}</span></h4>
            <p><strong>Recommendation:</strong> ${assessment.summary_and_recommendation || tool.summary_and_recommendation || 'Not available.'}</p>
            <div class="findings-container">
        `;

        if (assessment.assessment_details) {
            for (const [key, category] of Object.entries(assessment.assessment_details)) {
                html += `
                    <div class="finding-category">
                        <h5>${formatCategoryTitle(key)} (Score: ${category.category_score})</h5>
                        <ul>
                            ${Object.values(category.criteria).map(c => `<li><strong>${c.score}/10:</strong> ${c.justification}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        } else {
            html += `<p>No detailed breakdown available for this tool.</p>`;
        }

        html += `</div>`;
        content.innerHTML = html;
        modal.style.display = 'block';

        // Close button logic
        const closeBtn = document.querySelector('#detailsModal .close');
        closeBtn.onclick = () => {
            modal.style.display = 'none';
        };
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    }

    function formatCategoryTitle(key) {
        return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
    
    // Fallback for older data that doesn't have the new `detailed_assessment` structure.
    function generateAssessmentFromLegacy(tool) {
        if (!tool || !tool.summary_and_recommendation) {
            return {
                summary_and_recommendation: "No summary available.",
                assessment_details: {}
            };
        }
        
        const details = {};
        const parts = tool.summary_and_recommendation.split('|').map(p => p.trim());
        const categories = ['dataStorage', 'trainingUsage', 'accessControls', 'complianceRisk', 'vendorTransparency'];
        
        categories.forEach((cat, index) => {
            details[cat] = {
                category_score: tool[`${cat}_score`] || 'N/A',
                criteria: {
                    summary: {
                        score: 'N/A',
                        justification: parts[index] || 'No details provided.'
                    }
                }
            };
        });

        return {
            summary_and_recommendation: parts[0] || tool.summary_and_recommendation,
            assessment_details: details
        };
    }

    // --- Import Modal Functions ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                window.importData = JSON.parse(e.target.result);
                document.getElementById('fileName').textContent = `File: ${file.name}`;
                document.getElementById('importOptions').style.display = 'block';
            } catch (error) {
                alert('❌ Invalid JSON file. Please select a valid assessment file.');
                console.error("JSON Parsing Error:", error);
            }
        };
        reader.readAsText(file);
    }

    async function processImport() {
        if (!window.importData || !window.importData.tools) {
            alert('❌ No valid data to import. Please select a file first.');
            return;
        }

        const importButton = document.querySelector('#importModal button');
        importButton.disabled = true;
        importButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';

        try {
            // IMPORTANT: Replace these with your actual Supabase project URL and Anon Key
            const SUPABASE_URL = "YOUR_SUPABASE_URL";
            const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

            if (SUPABASE_URL.includes("YOUR_SUPABASE_URL")) {
                alert('Please replace YOUR_SUPABASE_URL and YOUR_SUPABASE_ANON_KEY in the script inside New AI Tool Risk Dashboard.html');
                throw new Error('Supabase project details are not configured in the dashboard HTML file.');
            }

            const { createClient } = window.supabase;
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                alert('You must be logged in to import data.');
                throw new Error('User not authenticated.');
            }

            const { data, error } = await supabase.functions.invoke('upload-assessment', {
                body: { toolData: window.importData.tools[0] } // Assuming one tool per file for now
            });

            if (error) throw error;
            
            alert(`✅ Success: ${data.message}`);
            document.getElementById('importModal').style.display = 'none';
            loadDataFromDB(); // Refresh the grid

        } catch (error) {
            console.error('Import Error:', error);
            alert(`❌ Import Failed: ${error.message}`);
        } finally {
            importButton.disabled = false;
            importButton.innerHTML = 'Start Import';
        }
    }
</script>