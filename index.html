<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tool Risk Assessment</title>
    
    <!-- Add Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: #f8fafc;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.125rem;
            color: #64748b;
            font-weight: 400;
        }

        /* Progress Indicator */
        .progress-container {
            margin-bottom: 2rem;
        }

        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 500;
            color: #9ca3af;
        }

        .progress-step.active {
            color: #3b82f6;
        }

        .progress-step.completed {
            color: #10b981;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e5e7eb;
            color: #6b7280;
            margin-right: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .progress-step.active .step-number {
            background: #3b82f6;
            color: white;
        }

        .progress-step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-connector {
            width: 80px;
            height: 2px;
            background: #e5e7eb;
            margin: 0 1rem;
        }

        .progress-step.completed + .step-connector {
            background: #10b981;
        }

        /* Form Card */
        .form-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .form-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .form-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .form-content {
            padding: 2rem;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-label .required {
            color: #ef4444;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Two Column Layout */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Data Classification Section */
        .data-classification {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .classification-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }

        .classification-icon {
            margin-right: 0.5rem;
            font-size: 1.125rem;
        }

        .classification-description {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .classification-options {
            display: grid;
            gap: 0.75rem;
        }

        .classification-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .classification-option:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .classification-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .classification-radio {
            margin-right: 1rem;
            accent-color: #3b82f6;
        }

        .classification-label {
            flex: 1;
        }

        .classification-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .classification-example {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.4);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #f8fafc;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Loading States */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-card {
            display: none;
            margin-top: 2rem;
        }

        .results-card.active {
            display: block;
        }

        .risk-score-display {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }

        .risk-score-number {
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .risk-score-label {
            font-size: 1.25rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .risk-critical { color: #dc2626; }
        .risk-high { color: #ea580c; }
        .risk-medium { color: #ca8a04; }
        .risk-low { color: #16a34a; }

        .risk-description {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .risk-critical .risk-description { background: #fef2f2; color: #991b1b; }
        .risk-high .risk-description { background: #fff7ed; color: #9a3412; }
        .risk-medium .risk-description { background: #fefce8; color: #a16207; }
        .risk-low .risk-description { background: #f0fdf4; color: #166534; }

        /* Breakdown Cards */
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .breakdown-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .breakdown-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.875rem;
        }

        .breakdown-score {
            font-weight: 700;
            color: #3b82f6;
            font-size: 1.125rem;
        }

        .breakdown-description {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.5;
        }

        /* Messages */
        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
        }

        .message-success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }

        .message-error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }

        .message-warning {
            background: #fefce8;
            border-color: #fde68a;
            color: #a16207;
        }

        /* Hide sections by default */
        .step-section {
            display: none;
        }

        .step-section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>AI Tool Risk Assessment</h1>
            <p>Enterprise-grade security analysis for AI tools and platforms</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection">
            <!-- Login UI will be populated by JavaScript -->
        </div>

        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-step active" id="step1">
                    <span class="step-number">1</span>
                    <span>Tool Information</span>
                </div>
                <div class="step-connector"></div>
                <div class="progress-step" id="step2">
                    <span class="step-number">2</span>
                    <span>Data Classification</span>
                </div>
                <div class="step-connector"></div>
                <div class="progress-step" id="step3">
                    <span class="step-number">3</span>
                    <span>Analysis</span>
                </div>
                <div class="step-connector"></div>
                <div class="progress-step" id="step4">
                    <span class="step-number">4</span>
                    <span>Results</span>
                </div>
            </div>
        </div>

        <!-- Main Form Card -->
        <div class="form-card">
            <div class="form-header">
                <h2>Security Risk Assessment</h2>
                <p>Comprehensive analysis following enterprise security frameworks</p>
            </div>
            
            <div class="form-content">
                <form id="assessmentForm">
                    <!-- Step 1: Tool Information -->
                    <div class="step-section active" id="section1">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="toolName">
                                    Tool Name <span class="required">*</span>
                                </label>
                                <input type="text" id="toolName" name="toolName" class="form-input" 
                                       placeholder="e.g., ChatGPT, Claude, Midjourney" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="toolVersion">Tool Version</label>
                                <select id="toolVersion" name="toolVersion" class="form-select">
                                    <option value="free">Free/Personal Version</option>
                                    <option value="enterprise">Enterprise Version 🔒</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="toolCategory">Category</label>
                                <select id="toolCategory" name="toolCategory" class="form-select">
                                    <option value="">Select category</option>
                                    <option value="conversational-ai">Conversational AI</option>
                                    <option value="code-assistant">Code Assistant</option>
                                    <option value="content-generation">Content Generation</option>
                                    <option value="data-analysis">Data Analysis</option>
                                    <option value="productivity">Productivity Tool</option>
                                    <option value="design-creative">Design & Creative</option>
                                    <option value="translation">Translation & Language</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="useCase">Intended Use Case</label>
                                <select id="useCase" name="useCase" class="form-select">
                                    <option value="">Select primary use case</option>
                                    <option value="legal-compliance">Legal/Compliance/Audit</option>
                                    <option value="finance-accounting">Finance/Accounting</option>
                                    <option value="hr-executive">HR/Executive Communications</option>
                                    <option value="customer-support">Customer Data/Support</option>
                                    <option value="development">Internal IT/Development</option>
                                    <option value="marketing">Marketing/Public Content</option>
                                    <option value="research">Research & Analysis</option>
                                    <option value="general">General Business Use</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="toolUrl">Tool Website/URL</label>
                            <input type="url" id="toolUrl" name="toolUrl" class="form-input" 
                                   placeholder="https://...">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="additionalContext">Additional Context</label>
                            <textarea id="additionalContext" name="additionalContext" class="form-textarea" 
                                      placeholder="Provide any additional details about planned usage, specific features needed, or concerns..."></textarea>
                        </div>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Next: Data Classification →
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Data Classification -->
                    <div class="step-section" id="section2">
                        <div class="data-classification">
                            <div class="classification-title">
                                <span class="classification-icon">🔒</span>
                                Data Classification
                            </div>
                            <div class="classification-description">
                                Select the type of data that will be processed by this AI tool. This helps us apply appropriate security standards.
                            </div>
                            
                            <div class="classification-options">
                                <label class="classification-option" for="phi">
                                    <input type="radio" name="dataClassification" value="phi" id="phi" class="classification-radio">
                                    <div class="classification-label">
                                        <div class="classification-name">Protected Health Information (PHI)</div>
                                        <div class="classification-example">Medical records, patient data, health information</div>
                                    </div>
                                </label>
                                
                                <label class="classification-option" for="financial">
                                    <input type="radio" name="dataClassification" value="financial" id="financial" class="classification-radio">
                                    <div class="classification-label">
                                        <div class="classification-name">Financial/Payment Data</div>
                                        <div class="classification-example">Credit cards, banking info, SOX data, financial records</div>
                                    </div>
                                </label>
                                
                                <label class="classification-option" for="trade-secrets">
                                    <input type="radio" name="dataClassification" value="trade-secrets" id="trade-secrets" class="classification-radio">
                                    <div class="classification-label">
                                        <div class="classification-name">Trade Secrets/Intellectual Property</div>
                                        <div class="classification-example">Product designs, algorithms, proprietary information</div>
                                    </div>
                                </label>
                                
                                <label class="classification-option" for="pii">
                                    <input type="radio" name="dataClassification" value="pii" id="pii" class="classification-radio">
                                    <div class="classification-label">
                                        <div class="classification-name">Personally Identifiable Information</div>
                                        <div class="classification-example">SSN, addresses, employee data, personal information</div>
                                    </div>
                                </label>
                                
                                <label class="classification-option" for="public">
                                    <input type="radio" name="dataClassification" value="public" id="public" class="classification-radio">
                                    <div class="classification-label">
                                        <div class="classification-name">Public/Marketing Data</div>
                                        <div class="classification-example">Published content, public information, marketing materials</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="prevStep()">
                                ← Back
                            </button>
                            <button type="button" class="btn btn-primary" onclick="startAssessment()">
                                Start Assessment →
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Analysis (Loading) -->
                    <div class="step-section" id="section3">
                        <div class="loading active">
                            <div class="spinner"></div>
                            <h3>Analyzing Security Risk</h3>
                            <p id="analysisStatus">Initializing assessment...</p>
                        </div>
                    </div>

                    <!-- Step 4: Results -->
                    <div class="step-section" id="section4">
                        <div id="resultsContent">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="exportAssessment()">
                                📄 Export Report
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="saveToDatabase()">
                                💾 Save to Database
                            </button>
                            <button type="button" class="btn btn-primary" onclick="startNewAssessment()">
                                🔄 New Assessment
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://xhbhpnxqhkzrreglflgi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoYmhwbnhxaGt6cnJlZ2xmbGdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM2NzIwMzMsImV4cCI6MjA0OTI0ODAzM30.5TxB80D6HKZZHKIjAuQe5C0BsVfNF_dD-cTNrUX_pXg';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Authentication state
        let currentUser = null;
        let isAdmin = false;

        // Check auth state on load
        supabase.auth.onAuthStateChange((event, session) => {
            currentUser = session?.user || null;
            isAdmin = session?.user?.user_metadata?.role === 'admin';
            updateUIForAuth();
        });

        function updateUIForAuth() {
            const saveButton = document.querySelector('button[onclick="saveToDatabase()"]');
            const loginSection = document.getElementById('loginSection');
            
            if (saveButton) {
                if (isAdmin) {
                    saveButton.style.display = 'inline-flex';
                    saveButton.innerHTML = '💾 Save to Database (Admin)';
                } else {
                    saveButton.style.display = 'none';
                }
            }
            
            if (loginSection) {
                if (currentUser) {
                    loginSection.innerHTML = `
                        <div style="text-align: center; margin-bottom: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; border: 1px solid #bbf7d0;">
                            <span style="color: #166534;">✓ Logged in as: ${currentUser.email}</span>
                            ${isAdmin ? '<span style="color: #dc2626; margin-left: 0.5rem;">[ADMIN]</span>' : ''}
                            <button onclick="signOut()" style="margin-left: 1rem; padding: 0.25rem 0.5rem; background: #fee2e2; border: 1px solid #fecaca; border-radius: 0.25rem; color: #991b1b; cursor: pointer;">Sign Out</button>
                        </div>
                    `;
                } else {
                    loginSection.innerHTML = `
                        <div id="authContainer" style="text-align: center; margin-bottom: 1rem; padding: 1rem; background: #fffbeb; border-radius: 0.5rem; border: 1px solid #fed7aa;">
                            <div style="margin-bottom: 0.5rem; color: #92400e; font-weight: 600;">Admin Access Required for Database Operations</div>
                            <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
                                <input type="email" id="adminEmail" placeholder="Admin Email" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; min-width: 200px;">
                                <input type="password" id="adminPassword" placeholder="Admin Password" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.25rem; min-width: 150px;">
                                <button onclick="signInAdmin()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-weight: 600;">Admin Sign In</button>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">Public assessments don't require login</div>
                        </div>
                    `;
                }
            }
        }

        async function signInAdmin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!email || !password) {
                showMessage('Please enter email and password', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                // Check if user has admin role
                if (data.user?.user_metadata?.role !== 'admin') {
                    await supabase.auth.signOut();
                    showMessage('Access denied: Admin privileges required', 'error');
                    return;
                }
                
                showMessage('Admin login successful', 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Login failed: ' + error.message, 'error');
            }
        }

        async function signOut() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                showMessage('Signed out successfully', 'success');
            } catch (error) {
                console.error('Sign out error:', error);
                showMessage('Sign out failed: ' + error.message, 'error');
            }
        }

        // Data Classification Multipliers (hidden from UI)
        const DATA_CLASSIFICATION_MULTIPLIERS = {
            'phi': 1.4,
            'financial': 1.3,
            'trade-secrets': 1.25,
            'pii': 1.2,
            'public': 0.9
        };

        // Use Case Multipliers (hidden from UI)
        const USE_CASE_MULTIPLIERS = {
            'legal-compliance': 1.3,
            'finance-accounting': 1.2,
            'hr-executive': 1.15,
            'customer-support': 1.1,
            'development': 0.95,
            'marketing': 0.9
        };

        // Fallback database for when Supabase is unavailable (CORS issues)
        const FALLBACK_TOOLS_DB = {
            'chatgpt free': { score: 82, name: 'ChatGPT Free' },
            'chatgpt enterprise': { score: 26, name: 'ChatGPT Enterprise' },
            'claude free': { score: 68, name: 'Claude Free' },
            'claude enterprise': { score: 35, name: 'Claude Enterprise' },
            'github copilot free': { score: 56, name: 'GitHub Copilot Free' },
            'github copilot enterprise': { score: 42, name: 'GitHub Copilot Enterprise' },
            'fireflies.ai free': { score: 52, name: 'Fireflies.ai Free' },
            'fireflies.ai enterprise': { 
                score: 18, 
                name: 'Fireflies.ai Enterprise',
                detailed_assessment: {
                    "assessment_date": "2025-01-15",
                    "framework_version": "1.0",
                    "categories": {
                        "dataStorage": {
                            "total_score": 8,
                            "max_score": 25,
                            "subcategories": {
                                "geographic": {"score": 3, "justification": "US data centers with clear jurisdiction control"},
                                "encryption": {"score": 2, "justification": "AES-256 encryption at rest and TLS in transit"},
                                "retention": {"score": 3, "justification": "12-month default retention with user-controlled deletion"}
                            }
                        },
                        "trainingUsage": {
                            "total_score": 0,
                            "max_score": 25,
                            "subcategories": {
                                "training": {"score": 0, "justification": "Contractual guarantee - no training use (0-day retention policy)"},
                                "sharing": {"score": 0, "justification": "Business Associate Agreement with AI vendors prevents data sharing"}
                            }
                        },
                        "accessControls": {
                            "total_score": 8,
                            "max_score": 20,
                            "subcategories": {
                                "admin": {"score": 0, "justification": "Super Admin controls with comprehensive user management"},
                                "audit": {"score": 5, "justification": "Enhanced monitoring capabilities with activity logs"},
                                "integration": {"score": 3, "justification": "SSO support with secure team access"}
                            }
                        },
                        "complianceRisk": {
                            "total_score": 2,
                            "max_score": 20,
                            "subcategories": {
                                "violations": {"score": 0, "justification": "SOC 2 Type II, GDPR, and HIPAA-BAA compliant"},
                                "transparency": {"score": 2, "justification": "Minor gaps in detailed implementation documentation"}
                            }
                        },
                        "vendorTransparency": {
                            "total_score": 0,
                            "max_score": 10,
                            "subcategories": {
                                "documentation": {"score": 0, "justification": "Comprehensive security documentation and compliance certifications"}
                            }
                        }
                    }
                }
            },
            'cursor free': { score: 48, name: 'Cursor Free' },
            'cursor enterprise': { score: 35, name: 'Cursor Enterprise' },
            'read.ai free': { score: 61, name: 'Read.ai Free' },
            'read.ai enterprise': { score: 45, name: 'Read.ai Enterprise' },
            'midjourney free': { score: 65, name: 'Midjourney Free' },
            'midjourney enterprise': { score: 50, name: 'Midjourney Enterprise' }
        };

        // Global state
        let currentStep = 1;
        let currentAssessment = null;

        // Step navigation
        function nextStep() {
            if (currentStep === 1) {
                if (!validateStep1()) return;
                showStep(2);
            } else if (currentStep === 2) {
                if (!validateStep2()) return;
                showStep(3);
                startAssessment();
            }
        }

        function prevStep() {
            if (currentStep === 2) {
                showStep(1);
            }
        }

        function showStep(step) {
            // Hide all sections
            document.querySelectorAll('.step-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show target section
            document.getElementById(`section${step}`).classList.add('active');
            
            // Update progress steps
            document.querySelectorAll('.progress-step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            currentStep = step;
        }

        // Validation
        function validateStep1() {
            const toolName = document.getElementById('toolName').value.trim();
            if (!toolName) {
                showMessage('Please enter a tool name', 'error');
                return false;
            }
            return true;
        }

        function validateStep2() {
            const dataClassification = document.querySelector('input[name="dataClassification"]:checked');
            if (!dataClassification) {
                showMessage('Please select a data classification', 'error');
                return false;
            }
            return true;
        }

        // Radio button selection styling
        document.addEventListener('change', function(e) {
            if (e.target.name === 'dataClassification') {
                document.querySelectorAll('.classification-option').forEach(option => {
                    option.classList.remove('selected');
                });
                e.target.closest('.classification-option').classList.add('selected');
            }
        });

        // Assessment process
        async function startAssessment() {
            const formData = {
                toolName: document.getElementById('toolName').value.trim(),
                toolVersion: document.getElementById('toolVersion').value,
                toolCategory: document.getElementById('toolCategory').value,
                toolUrl: document.getElementById('toolUrl').value.trim(),
                useCase: document.getElementById('useCase').value,
                additionalContext: document.getElementById('additionalContext').value.trim(),
                dataClassification: document.querySelector('input[name="dataClassification"]:checked').value
            };

            // Check for Enterprise paywall
            if (formData.toolVersion === 'enterprise') {
                const shouldProceed = await showEnterprisePaywall();
                if (!shouldProceed) {
                    return; // User declined Enterprise assessment
                }
            }

            showStep(3);

            try {
                // Simulate analysis steps
                await simulateAnalysisSteps();
                
                // Generate assessment results
                const results = await generateAssessmentResults(formData);
                currentAssessment = { formData, results };
                
                // Show results
                displayResults(results);
                showStep(4);
                
            } catch (error) {
                console.error('Assessment error:', error);
                showMessage('Assessment failed: ' + error.message, 'error');
                showStep(2);
            }
        }

        async function simulateAnalysisSteps() {
            const steps = [
                'Analyzing data storage policies...',
                'Checking training data usage...',
                'Evaluating access controls...',
                'Assessing compliance requirements...',
                'Reviewing vendor transparency...',
                'Calculating risk score...',
                'Generating recommendations...'
            ];

            for (let i = 0; i < steps.length; i++) {
                document.getElementById('analysisStatus').textContent = steps[i];
                await new Promise(resolve => setTimeout(resolve, 800));
            }
        }

        async function generateAssessmentResults(formData) {
            // Try to get tool from database first
            const baseScoreResult = await getToolFromDatabase(formData);
            const baseScore = baseScoreResult.score;
            const source = baseScoreResult.source;
            
            const adjustedScore = applyMultipliers(baseScore, formData);
            
            // Debug logging
            console.log('=== TARGETED MULTIPLIER DEBUG ===');
            console.log('Tool:', formData.toolName, formData.toolVersion);
            console.log('Base Score:', baseScore, 'Source:', source);
            console.log('Data Classification:', formData.dataClassification, 'Multiplier:', DATA_CLASSIFICATION_MULTIPLIERS[formData.dataClassification]);
            console.log('Use Case:', formData.useCase, 'Multiplier:', USE_CASE_MULTIPLIERS[formData.useCase]);
            
            // Show which sections are affected
            const dataMultiplier = DATA_CLASSIFICATION_MULTIPLIERS[formData.dataClassification] || 1.0;
            const useCaseMultiplier = USE_CASE_MULTIPLIERS[formData.useCase] || 1.0;
            console.log('🎯 Sections affected by Data Classification multiplier:', 'Data Storage & Compliance Risk');
            console.log('🎯 Sections affected by Use Case multiplier:', 'Compliance Risk & Access Controls');
            console.log('📊 Final Score:', Math.min(100, Math.round(adjustedScore)));
            console.log('==========================================');
            
            // Store tool data for breakdown generation
            window.lastToolData = baseScoreResult;
            
            const riskLevel = getRiskLevel(adjustedScore);
            const breakdown = await generateBreakdown(formData);
            
            return {
                toolName: formData.toolName,
                baseScore: baseScore,
                finalScore: Math.min(100, Math.round(adjustedScore)),
                riskLevel: riskLevel,
                breakdown: breakdown,
                recommendations: generateRecommendations(adjustedScore, formData),
                timestamp: new Date().toISOString(),
                source: source,
                enhancedInfo: window.currentEnhancedInfo || null
            };
        }

        async function getToolFromDatabase(formData) {
            // First try fallback database (handles CORS issues)
            const fallbackResult = checkFallbackDatabase(formData);
            if (fallbackResult.found) {
                return fallbackResult;
            }

            // If not in fallback, try Supabase with detailed assessment data
            try {
                // Build search term based on tool name and version
                const searchTerms = buildSearchTerms(formData.toolName, formData.toolVersion);
                
                console.log('Searching Supabase for:', searchTerms);
                
                // Try each search term until we find a match
                for (const searchTerm of searchTerms) {
                    const { data, error } = await supabase
                        .from('ai_tools')
                        .select('name, total_score, detailed_assessment, breakdown, details, risk_level, compliance_score, data_storage_score, training_usage_score, access_controls_score, vendor_transparency_score')
                        .ilike('name', `%${searchTerm}%`)
                        .limit(1);
                    
                    if (error) {
                        console.warn('Supabase query error (likely CORS):', error.message);
                        continue;
                    }
                    
                    if (data && data.length > 0) {
                        const tool = data[0];
                        console.log(`Found tool in Supabase: ${tool.name} (score: ${tool.total_score})`);
                        console.log('Detailed assessment available:', !!tool.detailed_assessment);
                        
                        return { 
                            score: tool.total_score, 
                            source: 'database',
                            toolData: tool,
                            hasDetailedAssessment: !!tool.detailed_assessment
                        };
                    }
                }
                
                console.log('Tool not found in Supabase, using heuristic scoring');
                
            } catch (error) {
                console.warn('Supabase lookup failed (likely CORS):', error.message);
            }
            
            // Fall back to heuristic
            return { 
                score: generateHeuristicScore(formData), 
                source: 'heuristic' 
            };
        }

        function checkFallbackDatabase(formData) {
            // Build search term based on tool name and version
            const searchTerms = buildSearchTerms(formData.toolName, formData.toolVersion);
            
            console.log('Searching fallback database for:', searchTerms);
            
            // Try each search term until we find a match
            for (const searchTerm of searchTerms) {
                const key = searchTerm.toLowerCase();
                if (FALLBACK_TOOLS_DB[key]) {
                    const tool = FALLBACK_TOOLS_DB[key];
                    console.log(`Found tool in fallback database: ${tool.name} (score: ${tool.score})`);
                    return { 
                        score: tool.score, 
                        source: 'database',
                        found: true,
                        toolData: tool,
                        hasDetailedAssessment: !!tool.detailed_assessment
                    };
                }
            }
            
            console.log('Tool not found in fallback database');
            return { found: false };
        }

        function buildSearchTerms(toolName, toolVersion) {
            const cleanToolName = toolName.trim();
            const searchTerms = [];
            
            const versionSuffix = toolVersion === 'enterprise' ? 'Enterprise' : 'Free';
            
            // Check if tool name already includes the version suffix
            const toolNameLower = cleanToolName.toLowerCase();
            const suffixLower = versionSuffix.toLowerCase();
            
            if (!toolNameLower.includes(suffixLower)) {
                // Only add suffix if not already present
                searchTerms.push(`${cleanToolName} ${versionSuffix}`);
            }
            
            // Always try exact name as entered
            searchTerms.push(cleanToolName);
            
            return searchTerms;
        }

        function generateHeuristicScore(formData) {
            // Fallback scoring for unknown tools
            let score = 60; // Higher default for unknown tools (more conservative)
            
            const toolName = formData.toolName.toLowerCase();
            
            // Adjust based on version
            if (formData.toolVersion === 'enterprise') {
                score -= 15; // Enterprise typically safer
            }
            
            // Category adjustments
            if (formData.toolCategory === 'conversational-ai') {
                score += 15; // Conversational AI tends to be higher risk
            } else if (formData.toolCategory === 'code-assistant') {
                score += 5;
            } else if (formData.toolCategory === 'productivity') {
                score += 10;
            }
            
            return Math.min(100, Math.max(20, score)); // Keep between 20-100
        }

        function applyMultipliers(baseScore, formData) {
            // Break down the base score into components proportionally
            // Based on framework: Data Storage(25), Training(25), Access(20), Compliance(20), Vendor(10)
            const scoreBreakdown = {
                dataStorage: Math.round(baseScore * 0.25), // 25% of total
                trainingUsage: Math.round(baseScore * 0.25), // 25% of total
                accessControls: Math.round(baseScore * 0.20), // 20% of total
                complianceRisk: Math.round(baseScore * 0.20), // 20% of total
                vendorTransparency: Math.round(baseScore * 0.10) // 10% of total
            };
            
            // Apply targeted data classification multipliers
            const dataMultiplier = DATA_CLASSIFICATION_MULTIPLIERS[formData.dataClassification] || 1.0;
            scoreBreakdown.dataStorage *= dataMultiplier; // Data storage most affected by data type
            scoreBreakdown.complianceRisk *= dataMultiplier; // Compliance risk varies by data type
            
            // Apply targeted use case multipliers  
            const useCaseMultiplier = USE_CASE_MULTIPLIERS[formData.useCase] || 1.0;
            scoreBreakdown.complianceRisk *= useCaseMultiplier; // Legal use cases need higher compliance
            scoreBreakdown.accessControls *= useCaseMultiplier; // Sensitive use cases need better controls
            
            // Round the final component scores
            scoreBreakdown.dataStorage = Math.round(scoreBreakdown.dataStorage);
            scoreBreakdown.trainingUsage = Math.round(scoreBreakdown.trainingUsage);
            scoreBreakdown.accessControls = Math.round(scoreBreakdown.accessControls);
            scoreBreakdown.complianceRisk = Math.round(scoreBreakdown.complianceRisk);
            scoreBreakdown.vendorTransparency = Math.round(scoreBreakdown.vendorTransparency);
            
            // Store breakdown for use in results display
            window.currentScoreBreakdown = scoreBreakdown;
            
            // Recalculate total score from adjusted components
            const adjustedScore = scoreBreakdown.dataStorage + 
                                scoreBreakdown.trainingUsage + 
                                scoreBreakdown.accessControls + 
                                scoreBreakdown.complianceRisk + 
                                scoreBreakdown.vendorTransparency;
            
            return adjustedScore;
        }

        function getRiskLevel(score) {
            if (score >= 80) return 'critical';
            if (score >= 60) return 'high';
            if (score >= 35) return 'medium';
            return 'low';
        }

        function getUseCaseLabel(useCase) {
            const useCaseLabels = {
                'legal-compliance': 'Legal/Compliance/Audit',
                'finance-accounting': 'Finance/Accounting',
                'hr-executive': 'HR/Executive Communications',
                'customer-support': 'Customer Data/Support',
                'development': 'Internal IT/Development',
                'marketing': 'Marketing/Public Content',
                'research': 'Research & Analysis',
                'general': 'General Business Use'
            };
            return useCaseLabels[useCase] || useCase;
        }

        async function generateBreakdown(formData) {
            // Check if we have detailed assessment data from previous query
            if (window.lastToolData && window.lastToolData.hasDetailedAssessment) {
                return generateDetailedBreakdown(window.lastToolData.toolData, formData);
            }
            
            // Try to get detailed breakdown from database
            try {
                const searchTerms = buildSearchTerms(formData.toolName, formData.toolVersion);
                
                for (const searchTerm of searchTerms) {
                    const { data, error } = await supabase
                        .from('ai_tools')
                        .select('breakdown, details, detailed_assessment')
                        .ilike('name', `%${searchTerm}%`)
                        .limit(1);
                    
                    if (data && data.length > 0) {
                        // Prefer detailed assessment if available
                        if (data[0].detailed_assessment) {
                            return generateDetailedBreakdown(data[0], formData);
                        }
                        // Fall back to simple breakdown
                        if (data[0].breakdown) {
                            return data[0].breakdown;
                        }
                    }
                }
            } catch (error) {
                console.warn('Could not fetch breakdown from database:', error);
            }
            
            // Fallback to generic breakdown
            return generateGenericBreakdown(formData);
        }

        function generateDetailedBreakdown(toolData, formData) {
            // Generate Pro-level detailed breakdown from database assessment
            const detailed = toolData.detailed_assessment;
            
            if (!detailed || !detailed.categories) {
                // Fall back to simple breakdown if detailed data is malformed
                return generateGenericBreakdown(formData);
            }
            
            const breakdown = {};
            const categoryMapping = {
                'dataStorage': 'Data Storage & Security',
                'trainingUsage': 'Training Data Usage', 
                'accessControls': 'Access Controls',
                'complianceRisk': 'Compliance Risk',
                'vendorTransparency': 'Vendor Transparency'
            };
            
            // Build detailed breakdown with justifications
            Object.keys(categoryMapping).forEach(key => {
                const category = detailed.categories[key];
                const displayName = categoryMapping[key];
                
                if (category) {
                    breakdown[displayName] = {
                        score: `${category.total_score}/${category.max_score}`,
                        description: category.description || 'Detailed assessment available',
                        subcategories: category.subcategories || {},
                        isDetailed: true // Flag for enhanced display
                    };
                } else {
                    // Fallback for missing categories
                    breakdown[displayName] = {
                        score: 'N/A',
                        description: 'Assessment data not available',
                        isDetailed: false
                    };
                }
            });
            
            // Store enhanced info for additional sections
            window.currentEnhancedInfo = {
                keyStrengths: detailed.keyStrengths || [],
                areasForMonitoring: detailed.areasForMonitoring || [],
                recommendations: detailed.recommendations || [],
                executiveSummary: detailed.executiveSummary || null
            };
            
            console.log('📋 Generated detailed breakdown for Pro user');
            return breakdown;
        }

        function generateGenericBreakdown(formData) {
            // Use the actual calculated component scores if available
            if (window.currentScoreBreakdown) {
                const breakdown = window.currentScoreBreakdown;
                const isEnterprise = formData.toolVersion === 'enterprise';
                
                return {
                    'Data Storage & Security': { 
                        score: `${breakdown.dataStorage}/25`, 
                        description: isEnterprise ? 'Better data residency controls and encryption' : 'Limited visibility into data storage practices' 
                    },
                    'Training Data Usage': { 
                        score: `${breakdown.trainingUsage}/25`, 
                        description: isEnterprise ? 'Typically offers training opt-out options' : 'High risk - data may be used for model training' 
                    },
                    'Access Controls': { 
                        score: `${breakdown.accessControls}/20`, 
                        description: isEnterprise ? 'Enhanced admin controls and user management' : 'Limited enterprise admin controls available' 
                    },
                    'Compliance Risk': { 
                        score: `${breakdown.complianceRisk}/20`, 
                        description: isEnterprise ? 'Better compliance frameworks and certifications' : 'Potential regulatory compliance gaps' 
                    },
                    'Vendor Transparency': { 
                        score: `${breakdown.vendorTransparency}/10`, 
                        description: isEnterprise ? 'Better documentation and support channels' : 'Limited transparency on data practices' 
                    }
                };
            }
            
            // Fallback for when no breakdown is available
            const isEnterprise = formData.toolVersion === 'enterprise';
            return {
                'Data Storage & Security': { 
                    score: isEnterprise ? '12/25' : '18/25', 
                    description: isEnterprise ? 'Better data residency controls and encryption' : 'Limited visibility into data storage practices' 
                },
                'Training Data Usage': { 
                    score: isEnterprise ? '8/25' : '20/25', 
                    description: isEnterprise ? 'Typically offers training opt-out options' : 'High risk - data may be used for model training' 
                },
                'Access Controls': { 
                    score: isEnterprise ? '10/20' : '18/20', 
                    description: isEnterprise ? 'Enhanced admin controls and user management' : 'Limited enterprise admin controls available' 
                },
                'Compliance Risk': { 
                    score: isEnterprise ? '8/20' : '15/20', 
                    description: isEnterprise ? 'Better compliance frameworks and certifications' : 'Potential regulatory compliance gaps' 
                },
                'Vendor Transparency': { 
                    score: isEnterprise ? '2/10' : '5/10', 
                    description: isEnterprise ? 'Better documentation and support channels' : 'Limited transparency on data practices' 
                }
            };
        }

        // Enterprise paywall function
        async function showEnterprisePaywall() {
            return new Promise((resolve) => {
                const paywallHTML = `
                    <div style="
                        position: fixed; 
                        top: 0; left: 0; 
                        width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.8); 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        z-index: 1000;
                    ">
                        <div style="
                            background: white; 
                            padding: 2rem; 
                            border-radius: 1rem; 
                            max-width: 500px; 
                            text-align: center;
                            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                        ">
                            <h3 style="color: #1e293b; margin-bottom: 1rem;">🔒 Enterprise Assessment</h3>
                            <p style="color: #64748b; margin-bottom: 2rem;">
                                Enterprise assessments provide detailed category-by-category analysis using 
                                objective security criteria with comprehensive justifications.
                            </p>
                            <div style="
                                background: #f8fafc; 
                                padding: 1rem; 
                                border-radius: 0.5rem; 
                                margin-bottom: 2rem;
                                border-left: 4px solid #3b82f6;
                            ">
                                <p style="font-weight: 600; color: #1e293b;">📊 Pro Assessment Features</p>
                                <p style="font-size: 0.875rem; color: #64748b;">
                                    • <strong>Detailed Component Scoring:</strong> Individual scores for each security category with evidence<br>
                                    • <strong>Objective Criteria Analysis:</strong> Measurable standards vs. subjective assessments<br>
                                    • <strong>Compliance Justifications:</strong> Specific reasoning for each risk factor<br>
                                    • <strong>Subcategory Breakdowns:</strong> Geographic, encryption, retention analysis<br>
                                    • <strong>Audit-Ready Reports:</strong> Defensible documentation for enterprise decisions
                                </p>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button id="paywallContinue" style="
                                    background: #3b82f6; 
                                    color: white; 
                                    border: none; 
                                    padding: 0.75rem 1.5rem; 
                                    border-radius: 0.5rem; 
                                    cursor: pointer;
                                    font-weight: 600;
                                ">Continue Free Assessment</button>
                                <button id="paywallCancel" style="
                                    background: #f8fafc; 
                                    color: #475569; 
                                    border: 1px solid #e2e8f0; 
                                    padding: 0.75rem 1.5rem; 
                                    border-radius: 0.5rem; 
                                    cursor: pointer;
                                    font-weight: 600;
                                ">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', paywallHTML);
                
                document.getElementById('paywallContinue').onclick = () => {
                    document.body.removeChild(document.body.lastChild);
                    resolve(true);
                };
                
                document.getElementById('paywallCancel').onclick = () => {
                    document.body.removeChild(document.body.lastChild);
                    resolve(false);
                };
            });
        }

        function generateRecommendations(score, formData) {
            const riskLevel = getRiskLevel(score);
            const dataType = formData.dataClassification;
            
            let recommendations = [];
            
            if (riskLevel === 'critical') {
                recommendations.push('🚫 IMMEDIATE ACTION REQUIRED: This tool should not be used with the selected data type');
                recommendations.push('🔒 Consider enterprise alternatives with stronger security controls');
            } else if (riskLevel === 'high') {
                recommendations.push('⚠️ Significant security controls required before deployment');
                recommendations.push('📋 Implement data loss prevention (DLP) policies');
            }
            
            if (dataType === 'phi') {
                recommendations.push('🏥 HIPAA compliance verification required');
                recommendations.push('📄 Business Associate Agreement (BAA) must be signed');
            } else if (dataType === 'financial') {
                recommendations.push('💳 PCI-DSS compliance verification required');
                recommendations.push('📊 SOX controls implementation needed');
            }
            
            return recommendations;
        }

        function displayResults(results) {
            const riskLevel = results.riskLevel;
            const riskLabels = {
                'critical': 'CRITICAL RISK',
                'high': 'HIGH RISK',
                'medium': 'MEDIUM RISK',
                'low': 'LOW RISK'
            };
            
            const riskDescriptions = {
                'critical': 'Immediate blocking required. This tool poses severe security risks.',
                'high': 'Significant controls needed before use. Enhanced monitoring required.',
                'medium': 'Standard enterprise controls required. Regular audit recommended.',
                'low': 'Basic monitoring sufficient. Tool meets security standards.'
            };

            // Get data classification display name
            const dataClassificationLabels = {
                'phi': 'Protected Health Information (PHI)',
                'financial': 'Financial/Payment Data',
                'trade-secrets': 'Trade Secrets/Intellectual Property',
                'pii': 'Personally Identifiable Information',
                'public': 'Public/Marketing Data'
            };
            
            const dataClassificationLabel = dataClassificationLabels[currentAssessment.formData.dataClassification] || 'Unknown Data Type';
            
            // Get data classification color for badge
            const dataClassificationColors = {
                'phi': '#dc2626', // Red for PHI (highest risk)
                'financial': '#ea580c', // Orange for Financial
                'trade-secrets': '#ca8a04', // Yellow for Trade Secrets
                'pii': '#3b82f6', // Blue for PII
                'public': '#16a34a' // Green for Public (lowest risk)
            };
            
            const dataClassificationColor = dataClassificationColors[currentAssessment.formData.dataClassification] || '#64748b';

            const resultsHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="font-size: 1.75rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">
                        ${results.toolName}${currentAssessment.formData.toolVersion === 'enterprise' && !results.toolName.toLowerCase().includes('enterprise') ? ' Enterprise' : ''}
                    </h2>
                    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                        <span style="
                            display: inline-block;
                            background: ${dataClassificationColor};
                            color: white;
                            padding: 0.375rem 0.75rem;
                            border-radius: 1rem;
                            font-size: 0.875rem;
                            font-weight: 600;
                            letter-spacing: 0.025em;
                        ">
                            🔒 ${dataClassificationLabel}
                        </span>
                        ${currentAssessment.formData.useCase ? `
                        <span style="
                            display: inline-block;
                            background: #64748b;
                            color: white;
                            padding: 0.375rem 0.75rem;
                            border-radius: 1rem;
                            font-size: 0.875rem;
                            font-weight: 600;
                            letter-spacing: 0.025em;
                        ">
                            📋 ${getUseCaseLabel(currentAssessment.formData.useCase)}
                        </span>
                        ` : ''}
                    </div>
                    <p style="color: #64748b; font-size: 1rem;">Risk Assessment Results</p>
                </div>
                
                <div class="risk-score-display risk-${riskLevel}">
                    <div class="risk-score-number">${results.finalScore}</div>
                    <div class="risk-score-label">${riskLabels[riskLevel]}</div>
                    <div class="risk-description">${riskDescriptions[riskLevel]}</div>
                    ${results.source === 'database' ? 
                        '<div style="margin-top: 0.5rem; font-size: 0.75rem; color: #10b981;">✓ Verified Assessment Data</div>' : 
                        '<div style="margin-top: 0.5rem; font-size: 0.75rem; color: #f59e0b;">⚠ Estimated Assessment</div>'
                    }
                </div>
                
                <div class="breakdown-grid">
                    ${Object.entries(results.breakdown).map(([category, data]) => `
                        <div class="breakdown-card">
                            <div class="breakdown-header">
                                <div class="breakdown-title">${category}</div>
                                <div class="breakdown-score">${data.score}</div>
                                ${data.isDetailed ? '<span style="color: #10b981; font-size: 0.75rem; margin-left: 0.5rem;">📊 Detailed</span>' : ''}
                            </div>
                            <div class="breakdown-description">${data.description}</div>
                            ${data.isDetailed && data.subcategories ? generateSubcategoryDisplay(data.subcategories) : ''}
                        </div>
                    `).join('')}
                </div>
                
                ${results.enhancedInfo ? generateEnhancedSections(results.enhancedInfo) : ''}
                
                ${results.recommendations.length > 0 ? `
                    <div class="message message-warning">
                        <h4>🎯 Recommendations</h4>
                        <ul style="margin: 0.5rem 0 0 1rem;">
                            ${results.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('resultsContent').innerHTML = resultsHTML;
        }

        function generateSubcategoryDisplay(subcategories) {
            if (!subcategories || Object.keys(subcategories).length === 0) {
                return '';
            }
            
            const subcategoryHTML = Object.entries(subcategories).map(([subKey, subData]) => {
                if (subData && subData.justification) {
                    return `
                        <div style="
                            margin-top: 0.75rem; 
                            padding: 0.5rem; 
                            background: #f8fafc; 
                            border-radius: 0.375rem; 
                            border-left: 3px solid #3b82f6;
                            font-size: 0.875rem;
                        ">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 0.25rem;">
                                ${subKey.charAt(0).toUpperCase() + subKey.slice(1)} (${subData.score} pts)
                            </div>
                            <div style="color: #64748b;">
                                ${subData.justification}
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
            
            return subcategoryHTML;
        }

        function generateEnhancedSections(enhancedInfo) {
            if (!enhancedInfo) return '';

            let sectionsHTML = '';

            // Key Strengths
            if (enhancedInfo.keyStrengths && enhancedInfo.keyStrengths.length > 0) {
                sectionsHTML += `
                    <div style="
                        margin-top: 2rem; 
                        padding: 1.5rem; 
                        background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%); 
                        border-radius: 0.75rem; 
                        border-left: 4px solid #10b981;
                    ">
                        <h4 style="color: #065f46; margin-bottom: 1rem; font-weight: 600;">✅ Key Strengths</h4>
                        <ul style="margin: 0; padding-left: 1.25rem; color: #064e3b;">
                            ${enhancedInfo.keyStrengths.map(strength => `<li style="margin-bottom: 0.5rem;">${strength}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Areas for Monitoring
            if (enhancedInfo.areasForMonitoring && enhancedInfo.areasForMonitoring.length > 0) {
                sectionsHTML += `
                    <div style="
                        margin-top: 1.5rem; 
                        padding: 1.5rem; 
                        background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); 
                        border-radius: 0.75rem; 
                        border-left: 4px solid #f59e0b;
                    ">
                        <h4 style="color: #92400e; margin-bottom: 1rem; font-weight: 600;">⚠️ Areas for Monitoring</h4>
                        <ul style="margin: 0; padding-left: 1.25rem; color: #78350f;">
                            ${enhancedInfo.areasForMonitoring.map(area => `<li style="margin-bottom: 0.5rem;">${area}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Implementation Recommendations
            if (enhancedInfo.recommendations && enhancedInfo.recommendations.length > 0) {
                sectionsHTML += `
                    <div style="
                        margin-top: 1.5rem; 
                        padding: 1.5rem; 
                        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
                        border-radius: 0.75rem; 
                        border-left: 4px solid #3b82f6;
                    ">
                        <h4 style="color: #1e40af; margin-bottom: 1rem; font-weight: 600;">🎯 Implementation Recommendations</h4>
                        <ul style="margin: 0; padding-left: 1.25rem; color: #1e3a8a;">
                            ${enhancedInfo.recommendations.map(rec => `<li style="margin-bottom: 0.5rem;">${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Executive Summary
            if (enhancedInfo.executiveSummary) {
                sectionsHTML += `
                    <div style="
                        margin-top: 1.5rem; 
                        padding: 1.5rem; 
                        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); 
                        border-radius: 0.75rem; 
                        border-left: 4px solid #64748b;
                    ">
                        <h4 style="color: #334155; margin-bottom: 1rem; font-weight: 600;">📋 Executive Summary</h4>
                        <p style="margin: 0; color: #475569; line-height: 1.6;">${enhancedInfo.executiveSummary}</p>
                    </div>
                `;
            }

            return sectionsHTML;
        }

        // Utility functions
        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message message-${type}`;
            messageEl.textContent = message;
            
            const container = document.querySelector('.form-content');
            container.insertBefore(messageEl, container.firstChild);
            
            setTimeout(() => messageEl.remove(), 5000);
        }

        async function saveToDatabase() {
            // Security check: Only admins can save to database
            if (!isAdmin) {
                showMessage('Access denied: Admin privileges required to save assessments', 'error');
                return;
            }

            if (!currentAssessment) {
                showMessage('No assessment to save', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('ai_tools')
                    .insert([{
                        name: currentAssessment.results.toolName,
                        total_score: currentAssessment.results.finalScore,
                        risk_level: currentAssessment.results.riskLevel.toUpperCase() + ' RISK',
                        category: currentAssessment.formData.toolCategory || 'Other',
                        breakdown: currentAssessment.results.breakdown,
                        details: {
                            formData: currentAssessment.formData,
                            recommendations: currentAssessment.results.recommendations
                        },
                        assessed_by: `Admin: ${currentUser.email}`,
                        notes: `Data Classification: ${currentAssessment.formData.dataClassification}`,
                        created_at: new Date().toISOString()
                    }]);

                if (error) {
                    console.error('Database error details:', error);
                    throw error;
                }
                
                showMessage('Assessment saved to database successfully!', 'success');
            } catch (error) {
                console.error('Save error:', error);
                if (error.code === '42501') {
                    showMessage('Database access denied: Please check admin permissions', 'error');
                } else {
                    showMessage('Failed to save to database: ' + error.message, 'error');
                }
            }
        }

        function exportAssessment() {
            if (!currentAssessment) {
                showMessage('No assessment to export', 'error');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                assessment: currentAssessment.results,
                formData: currentAssessment.formData,
                framework: {
                    version: "2.0",
                    description: "AI Tool Risk Assessment Framework with Data Classification"
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-assessment-${currentAssessment.results.toolName.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showMessage('Assessment exported successfully!', 'success');
        }

        function startNewAssessment() {
            document.getElementById('assessmentForm').reset();
            document.querySelectorAll('.classification-option').forEach(option => {
                option.classList.remove('selected');
            });
            currentAssessment = null;
            showStep(1);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showStep(1);
            updateUIForAuth(); // Initialize auth UI
        });
    </script>
</body>
</html>
