<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Risk Assessment Report</title>
    <style>
        /* === DYNAMIC VARIABLES === */
        :root {
            --risk-color: #3b82f6;
            --risk-degrees: 180deg;
        }

        /* === BASE STYLES === */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #1e293b;
            background: #f8fafc;
        }

        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* === HEADER === */
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 3rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(50px, -50px);
        }

        .header-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .report-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .report-subtitle {
            font-size: 1.25rem;
            opacity: 0.9;
            font-weight: 300;
            margin-bottom: 1.5rem;
        }

        .tool-highlight {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .tool-highlight .tool-name {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .tool-highlight .tool-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .report-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9rem;
        }

        /* === EXECUTIVE SUMMARY === */
        .executive-summary {
            padding: 2rem;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-header {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 3rem;
            margin-bottom: 2rem;
            align-items: center;
        }

        /* Simplified Risk Score Card */
        .risk-score-display {
            background: linear-gradient(135deg, var(--risk-color, #3b82f6) 0%, var(--risk-color-light, #60a5fa) 100%);
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            color: white;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 250px;
        }

        .risk-score-number {
            font-size: 4rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .risk-score-total {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .risk-level-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1rem;
            display: inline-block;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            backdrop-filter: blur(10px);
        }

        .risk-description {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Risk Level Color Variables */
        .risk-low {
            --risk-color: #10b981;
            --risk-color-light: #34d399;
        }

        .risk-medium {
            --risk-color: #f59e0b;
            --risk-color-light: #fbbf24;
        }

        .risk-high {
            --risk-color: #ef4444;
            --risk-color-light: #f87171;
        }

        .risk-critical {
            --risk-color: #dc2626;
            --risk-color-light: #ef4444;
        }

        .summary-insights {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .insight-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .insight-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .insight-text {
            color: #64748b;
            font-size: 0.95rem;
        }

        .key-findings {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .findings-title {
            color: #92400e;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .findings-list {
            color: #92400e;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* === TOOL INFORMATION === */
        .tool-info-section {
            padding: 2rem;
            background: #f8fafc;
        }

        .tool-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tool-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tool-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .tool-details {
            flex: 1;
        }

        .tool-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .tool-category {
            color: #64748b;
            font-size: 0.9rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #e2e8f0;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .info-value {
            font-weight: 500;
            color: #1f2937;
        }

        .info-value.critical {
            color: #dc2626;
            font-weight: 700;
        }

        /* === AZURE PERMISSIONS === */
        .permissions-section {
            padding: 2rem;
        }

        .permissions-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .permission-item {
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .permission-item.granted {
            background: #dcfce7;
            border-color: #16a34a;
            color: #166534;
        }

        .permission-item.limited {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .permission-item.denied {
            background: #fecaca;
            border-color: #dc2626;
            color: #991b1b;
        }

        .permission-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .permission-status {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* === RISK BREAKDOWN === */
        .risk-breakdown {
            padding: 2rem;
        }

        .categories-grid {
            /* CURRENT: Stacked List Layout - Best for long descriptions */
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            
            /* OPTION 2: Two-Column Grid - Balanced space
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
            */
            
            /* OPTION 3: Original Three-Column Grid - Compact
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            */
        }

        .category-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-top: 4px solid;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .category-card.low {
            border-top-color: #10b981;
        }

        .category-card.medium {
            border-top-color: #f59e0b;
        }

        .category-card.high {
            border-top-color: #ef4444;
        }

        .category-card.critical {
            border-top-color: #dc2626;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .category-name {
            font-weight: 600;
            color: #1e293b;
            flex: 1;
        }

        .category-score {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-left: 1rem;
        }

        .category-score.low {
            background: #dcfce7;
            color: #166534;
        }

        .category-score.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .category-score.high {
            background: #fecaca;
            color: #991b1b;
        }

        .category-score.critical {
            background: #dc2626;
            color: white;
        }

        .category-description {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #f1f5f9;
        }

        /* === RISK MATRIX === */
        .risk-matrix-section {
            padding: 2rem;
            background: #f8fafc;
        }

        .matrix-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .matrix-table th,
        .matrix-table td {
            padding: 1rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .matrix-table th {
            background: #1e40af;
            color: white;
        }

        .matrix-low { 
            background: #dcfce7; 
            color: #166534; 
        }

        .matrix-medium { 
            background: #fef3c7; 
            color: #92400e; 
        }

        .matrix-high { 
            background: #fecaca; 
            color: #991b1b; 
        }

        .matrix-critical { 
            background: #dc2626; 
            color: white; 
        }

        .current-risk {
            position: relative;
            font-weight: 800;
        }

        .current-risk::after {
            content: '‚òÖ';
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            color: #fbbf24;
            font-size: 1.2rem;
        }

        /* === RECOMMENDATIONS === */
        .recommendations-section {
            padding: 2rem;
        }

        .recommendations-grid {
            display: grid;
            gap: 1rem;
        }

        .recommendation-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
            transition: transform 0.2s ease;
        }

        .recommendation-card:hover {
            transform: translateX(4px);
        }

        .recommendation-card.priority-high {
            border-left-color: #dc2626;
            background: linear-gradient(to right, #fef2f2, white);
        }

        .recommendation-card.priority-medium {
            border-left-color: #f59e0b;
            background: linear-gradient(to right, #fef9e7, white);
        }

        .recommendation-card.priority-low {
            border-left-color: #16a34a;
            background: linear-gradient(to right, #f0fdf4, white);
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .recommendation-title {
            font-weight: 700;
            color: #1e293b;
        }

        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .priority-badge.priority-high {
            background: #dc2626;
            color: white;
        }

        .priority-badge.priority-medium {
            background: #f59e0b;
            color: white;
        }

        .priority-badge.priority-low {
            background: #16a34a;
            color: white;
        }

        .recommendation-text {
            color: #64748b;
            line-height: 1.6;
        }

        /* === FOOTER === */
        .footer {
            background: #1e293b;
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .confidential-banner {
            background: #dc2626;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .footer-section h4 {
            color: #3b82f6;
            margin-bottom: 0.5rem;
        }

        .footer-section p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .info-grid,
            .categories-grid,
            .permissions-grid {
                grid-template-columns: 1fr;
            }
            
            .report-title {
                font-size: 2rem;
            }
            
            .risk-score-display {
                min-width: auto;
                padding: 1.5rem;
            }

            .risk-score-number {
                font-size: 3rem;
            }
        }

        /* === PRINT OPTIMIZATION === */
        @media print {
            body {
                background: white;
            }

            .report-container {
                box-shadow: none;
            }

            .category-card,
            .recommendation-card {
                page-break-inside: avoid;
            }

            .section-title {
                page-break-after: avoid;
            }

            .risk-matrix-section {
                page-break-before: always;
            }
        }
    </style>
</head>
<body>
    <div class="report-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1 class="report-title">AI SECURITY RISK ASSESSMENT</h1>
                <p class="report-subtitle" id="reportSubtitle">Enterprise Security Analysis & Compliance Report</p>
                <div class="tool-highlight">
                    <div class="tool-name" id="headerToolName">Loading...</div>
                    <div class="tool-subtitle">Risk Assessment Report</div>
                </div>
                <div class="report-meta">
                    <div>
                        <strong>Assessment ID:</strong> <span id="headerAssessmentId">Loading...</span>
                    </div>
                    <div>
                        <strong>Generated:</strong> <span id="headerGeneratedDate">Loading...</span>
                    </div>
                    <div>
                        <strong>Framework:</strong> v2.1
                    </div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        <div class="executive-summary">
            <div class="summary-header">
                <h2 class="section-title">üìä Executive Summary</h2>
            </div>
            
            <div class="summary-grid">
                <div class="risk-score-display" id="riskScoreCard">
                    <div class="risk-score-number" id="riskScore">--</div>
                    <div class="risk-score-total">/100</div>
                    <div class="risk-level-badge" id="riskLevel">LOADING</div>
                    <div class="risk-description" id="riskDescription">Loading risk assessment...</div>
                </div>
                
                <div class="summary-insights" id="summaryInsights">
                    <div class="insight-card">
                        <div class="insight-title">Security Status</div>
                        <div class="insight-text" id="securityStatusText">Loading security status...</div>
                    </div>
                    
                    <div class="insight-card">
                        <div class="insight-title">Compliance Impact</div>
                        <div class="insight-text" id="complianceImpactText">Loading compliance assessment...</div>
                    </div>
                    
                    <div class="insight-card">
                        <div class="insight-title">Recommendation</div>
                        <div class="insight-text" id="mainRecommendationText">Loading recommendations...</div>
                    </div>
                </div>
            </div>

            <div class="key-findings">
                <div class="findings-title">
                    ‚ö†Ô∏è Key Security Findings
                </div>
                <div class="findings-list" id="keyFindings">
                    Loading key security findings...
                </div>
            </div>
        </div>

        <!-- Tool Information -->
        <div class="tool-info-section">
            <div class="tool-card">
                <div class="tool-header">
                    <div class="tool-icon" id="toolIcon">AI</div>
                    <div class="tool-details">
                        <div class="tool-name" id="toolName">Loading...</div>
                        <div class="tool-category" id="toolCategory">Loading category...</div>
                    </div>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Primary Use Case</span>
                        <span class="info-value" id="primaryUseCase">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Data Classification</span>
                        <span class="info-value" id="dataClassification">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Assessment Date</span>
                        <span class="info-value" id="assessmentDate">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Risk Category</span>
                        <span class="info-value" id="riskCategory">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Vendor</span>
                        <span class="info-value" id="vendor">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">License Type</span>
                        <span class="info-value" id="licenseType">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Azure Permissions -->
        <div class="permissions-section">
            <div class="permissions-card">
                <h2 class="section-title">üîê Azure AD Permissions Assessment</h2>
                <div class="permissions-grid" id="azurePermissions">
                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                        Loading Azure AD permissions assessment...
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Breakdown -->
        <div class="risk-breakdown">
            <h2 class="section-title">üîç Security Risk Analysis</h2>
            
            <div class="categories-grid" id="securityCategoriesGrid">
                <!-- Security categories will be populated dynamically from Supabase -->
                <div class="loading-message" style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #64748b;">
                    Loading security assessment data...
                </div>
            </div>
        </div>

        <!-- Risk Matrix -->
        <div class="risk-matrix-section">
            <div class="matrix-container">
                <h2 class="section-title">üìà Risk Assessment Matrix</h2>
                
                <table class="matrix-table">
                    <tr>
                        <th>Impact ‚Üí Likelihood ‚Üì</th>
                        <th>Low (0-34)</th>
                        <th>Medium (35-59)</th>
                        <th>High (60-79)</th>
                        <th>Critical (80-100)</th>
                    </tr>
                    <tr>
                        <th>Very Likely</th>
                        <td class="matrix-medium">Medium</td>
                        <td class="matrix-high">High</td>
                        <td class="matrix-critical">Critical</td>
                        <td class="matrix-critical">Critical</td>
                    </tr>
                    <tr>
                        <th>Likely</th>
                        <td class="matrix-low">Low</td>
                        <td class="matrix-medium">Medium</td>
                        <td class="matrix-high">High</td>
                        <td class="matrix-critical">Critical</td>
                    </tr>
                    <tr>
                        <th>Possible</th>
                        <td class="matrix-low" id="currentRiskMatrixCell">Low</td>
                        <td class="matrix-low">Low</td>
                        <td class="matrix-medium">Medium</td>
                        <td class="matrix-high">High</td>
                    </tr>
                    <tr>
                        <th>Unlikely</th>
                        <td class="matrix-low">Low</td>
                        <td class="matrix-low">Low</td>
                        <td class="matrix-low">Low</td>
                        <td class="matrix-medium">Medium</td>
                    </tr>
                </table>
                
                <p style="font-size: 0.9rem; color: #64748b; text-align: center; margin-top: 1rem;" id="matrixDescription">
                    ‚òÖ Current Risk Level: Loading assessment data...
                </p>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="recommendations-section">
            <h2 class="section-title">üéØ Action Items & Recommendations</h2>
            
            <div class="recommendations-grid" id="recommendationsGrid">
                <div style="text-align: center; padding: 2rem; color: #64748b;">
                    Loading action items and recommendations...
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="confidential-banner">
                üîí Confidential - Internal Use Only
            </div>
            <div class="footer-grid">
                <div class="footer-section">
                    <h4>Assessment Framework</h4>
                    <p>AI Tool Risk Assessment Framework v2.1</p>
                    <p>ISO 27001 Aligned</p>
                </div>
                <div class="footer-section">
                    <h4>Next Review</h4>
                    <p>Scheduled: <span id="nextReviewDate">Loading...</span></p>
                    <p>Quarterly Assessment Cycle</p>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p>Security Team: security@company.com</p>
                    <p>CISO Office: ciso@company.com</p>
                </div>
            </div>
            <div style="margin-top: 1rem; font-size: 0.9rem;">
                AI Tool Risk Assessment Framework v2.1<br>
                Assessment ID: <span id="footerAssessmentId">Loading...</span> | Generated: <span id="footerGeneratedDate">Loading...</span><br>
                ¬© 2025 Enterprise Security Office
            </div>
        </div>
    </div>

    <!-- Add Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Initialize Supabase (use your existing configuration)
        const SUPABASE_URL = 'https://lgybmsziqjdmmxdiyils.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxneWJtc3ppcWpkbW14ZGl5aWxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3MTAzOTcsImV4cCI6MjA2NjI4NjM5N30.GFqiwK2qi3TnlUDCmdFZpG69pqdPP-jpbxdUGX6VlSg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Risk level calculation function for individual categories (using percentage)
        function calculateRiskLevel(score, maxScore = 25) {
            if (!score || score === 0) return 'LOW';
            
            const percentage = (score / maxScore) * 100;
            
            if (percentage >= 80) return 'HIGH';    // 80%+ of max score
            if (percentage >= 60) return 'MEDIUM';  // 60-79% of max score  
            return 'LOW';                           // < 60% of max score
        }

        // Get CSS class for risk level
        function getRiskLevelClass(riskLevel) {
            switch(riskLevel.toLowerCase()) {
                case 'high': return 'high';
                case 'medium': return 'medium';
                case 'low': return 'low';
                default: return 'low';
            }
        }

        // Security category descriptions matching your data structure
        const categoryDescriptions = {
            'dataStorage': {
                name: 'Data Storage & Security',
                description: 'Encryption, data residency, and storage practices'
            },
            'trainingUsage': {
                name: 'Training Data Usage', 
                description: 'Model training and data utilization policies'
            },
            'accessControls': {
                name: 'Access Controls',
                description: 'Authentication, authorization, and user management'
            },
            'complianceRisk': {
                name: 'Compliance Risk',
                description: 'Regulatory compliance and audit readiness'
            },
            'vendorTransparency': {
                name: 'Vendor Transparency',
                description: 'Documentation, SLAs, and incident response'
            }
        };

        // Generate detailed breakdown with sub-categories from your data
        function generateDescription(categoryKey, score, breakdownData) {
            const baseDesc = categoryDescriptions[categoryKey]?.description || 'Assessment data analysis';
            const riskLevel = calculateRiskLevel(score);
            
            // Check if this is a free version (embedded data from index.html)
            const isFreeVersion = window.EMBEDDED_TOOL_INFO?.isFreeVersion || false;
            
            // Handle both camelCase keys (dataStorage) and human-readable keys ("Data Storage & Security")
            const categoryKeyMap = {
                'dataStorage': 'Data Storage & Security',
                'trainingUsage': 'Training Data Usage', 
                'accessControls': 'Access Controls',
                'complianceRisk': 'Compliance Risk',
                'vendorTransparency': 'Vendor Transparency'
            };
            
            console.log(`üîç generateDescription called for ${categoryKey}:`, {
                score,
                riskLevel,
                breakdownData: breakdownData,
                hasSubScores: !!(breakdownData && breakdownData.subScores),
                categoryExists: !!(breakdownData && breakdownData.subScores && breakdownData.subScores[categoryKey])
            });
            
            // DEBUG: Show actual breakdown structure
            if (breakdownData) {
                console.log(`üîç Available breakdown keys:`, Object.keys(breakdownData));
                const humanReadableKey = categoryKeyMap[categoryKey];
                console.log(`üîç Looking for keys: "${categoryKey}" or "${humanReadableKey}"`);
                console.log(`üîç Direct category access: breakdownData["${humanReadableKey}"] =`, breakdownData[humanReadableKey]);
                if (breakdownData.subScores) {
                    console.log(`üîç subScores keys:`, Object.keys(breakdownData.subScores));
                }
            }
            
            // Try to extract detailed sub-category notes from your breakdown structure
            
            const humanReadableKey = categoryKeyMap[categoryKey];
            let targetCategory = null;
            
            // First try the database format with subScores
            if (breakdownData && breakdownData.subScores) {
                targetCategory = breakdownData.subScores[categoryKey] || breakdownData.subScores[humanReadableKey];
            }
            
            // If not found, try direct category access (alternative breakdown format)
            if (!targetCategory && breakdownData) {
                targetCategory = breakdownData[categoryKey] || breakdownData[humanReadableKey];
            }
            
            if (targetCategory) {
                const subCategoryDetails = [];
                
                console.log(`‚úÖ Found category data for ${categoryKey} (using key: ${targetCategory === breakdownData[humanReadableKey] ? humanReadableKey : categoryKey}):`, targetCategory);
                
                // Map sub-score keys to readable names
                const subCategoryNames = {
                    'retention': 'üìÖ Data Retention',
                    'encryption': 'üîí Encryption',
                    'geographic': 'üåç Geographic Controls',
                    'sharing': 'üîÑ Data Sharing',
                    'training': 'ü§ñ Training Usage',
                    'admin': 'üë• Admin Controls',
                    'audit': 'üìä Audit & Monitoring',
                    'integration': 'üîó Integration',
                    'violations': '‚ö†Ô∏è Compliance Violations',
                    'transparency': 'üìã Policy Transparency',
                    'score': 'üìà Overall Assessment'
                };
                
                // Extract and format each sub-category
                Object.keys(targetCategory).forEach(subKey => {
                    const subItem = targetCategory[subKey];
                    
                    // Handle different data structures
                    let note = null;
                    if (subItem && typeof subItem === 'object' && subItem.note) {
                        // Standard structure: {retention: {note: "...", score: 5}}
                        note = subItem.note;
                    } else if (subItem && typeof subItem === 'string') {
                        // Simple structure: {retention: "Some note"}
                        note = subItem;
                    } else if (subItem && subItem.description) {
                        // Alternative structure: {retention: {description: "..."}}
                        note = subItem.description;
                    }
                    
                    if (note) {
                        const displayName = subCategoryNames[subKey] || `üìå ${subKey.charAt(0).toUpperCase() + subKey.slice(1)}`;
                        subCategoryDetails.push(`<strong>${displayName}:</strong> ${note}`);
                        console.log(`üìù Added note for ${subKey}: ${note.substring(0, 50)}...`);
                    }
                });
                
                if (subCategoryDetails.length > 0) {
                    console.log(`‚úÖ Returning ${subCategoryDetails.length} detailed notes for ${categoryKey}`);
                    return subCategoryDetails.join('<br><br>');
                } else {
                    console.log(`‚ö†Ô∏è No notes found in category data for ${categoryKey}`);
                }
            } else {
                console.log(`‚ùå No category data found for ${categoryKey} (tried keys: ${categoryKey}, ${humanReadableKey}). Falling back to generic description.`);
            }
            
            // Check if there's a details field for this category (from your data structure)
            if (breakdownData && breakdownData.details && breakdownData.details[categoryKey]) {
                return breakdownData.details[categoryKey];
            }
            
            // Fallback descriptions based on risk level and category
            if (isFreeVersion) {
                // Simplified descriptions for free users
                switch(categoryKey) {
                    case 'dataStorage':
                        return `${getQualitativeRisk(riskLevel)} data storage practices. Key security measures evaluated.`;
                    case 'trainingUsage':
                        return `${getQualitativeRisk(riskLevel)} training data usage. Model training policies assessed.`;
                    case 'accessControls':
                        return `${getQualitativeRisk(riskLevel)} access controls. User management and authentication reviewed.`;
                    case 'complianceRisk':
                        return `${getQualitativeRisk(riskLevel)} compliance assessment. Regulatory alignment evaluated.`;
                    case 'vendorTransparency':
                        return `${getQualitativeRisk(riskLevel)} vendor practices. Documentation and support reviewed.`;
                    default:
                        return `${getQualitativeRisk(riskLevel)} assessment completed.`;
                }
            } else {
                // Detailed descriptions for enterprise users
                switch(categoryKey) {
                    case 'dataStorage':
                        return `${getQualitativeRisk(riskLevel)} data storage assessment. Encryption, retention, and geographic controls evaluated.`;
                    case 'trainingUsage':
                        return `${getQualitativeRisk(riskLevel)} training data usage assessment. Model training and data sharing policies reviewed.`;
                    case 'accessControls':
                        return `${getQualitativeRisk(riskLevel)} access controls assessment. Authentication, authorization, and audit capabilities evaluated.`;
                    case 'complianceRisk':
                        return `${getQualitativeRisk(riskLevel)} compliance assessment. Regulatory requirements and frameworks reviewed.`;
                    case 'vendorTransparency':
                        return `${getQualitativeRisk(riskLevel)} vendor transparency assessment. Documentation, support, and transparency evaluated.`;
                    default:
                        return `${getQualitativeRisk(riskLevel)} assessment for ${baseDesc.toLowerCase()}.`;
                }
            }
        }

        // Helper function to get qualitative risk description
        function getQualitativeRisk(riskLevel) {
            switch(riskLevel) {
                case 'HIGH': return 'High-risk';
                case 'MEDIUM': return 'Medium-risk';
                case 'LOW': return 'Low-risk';
                default: return 'Standard';
            }
        }

        // Build search terms using the same logic as index.html
        function buildSearchTerms(toolName, toolVersion) {
            const cleanToolName = toolName.trim();
            const searchTerms = [];
            
            const versionSuffix = toolVersion === 'enterprise' ? 'Enterprise' : 'Free';
            
            // Check if tool name already includes the version suffix
            const toolNameLower = cleanToolName.toLowerCase();
            const suffixLower = versionSuffix.toLowerCase();
            
            // PRIORITY 1: Try exact matches with version first
            if (!toolNameLower.includes(suffixLower)) {
                // Try common database naming patterns for the specific version
                searchTerms.push(`${cleanToolName}.ai ${versionSuffix}`); // "Claude.ai Enterprise"
                searchTerms.push(`${cleanToolName} ${versionSuffix}`);    // "Claude Enterprise"
                
                // Try variations of the tool name
                if (cleanToolName.toLowerCase() === 'claude') {
                    searchTerms.push(`Claude.ai ${versionSuffix}`);
                } else if (cleanToolName.toLowerCase() === 'chatgpt') {
                    searchTerms.push(`ChatGPT ${versionSuffix}`);
                } else if (cleanToolName.toLowerCase().includes('copilot')) {
                    searchTerms.push(`GitHub Copilot ${versionSuffix}`);
                    searchTerms.push(`Microsoft Copilot ${versionSuffix}`);
                }
            }
            
            // PRIORITY 2: Try exact name as entered (only if no version-specific matches)
            searchTerms.push(cleanToolName);
            
            console.log(`üîç [TEMPLATE] Built search terms for "${toolName}" (${toolVersion}):`, searchTerms);
            
            return searchTerms;
        }

        // Load security assessment data - prioritize embedded data over database queries
        async function loadSecurityAssessment() {
            try {
                let toolName, toolVersion;

                // PRIORITY 1: Get tool info from index.html
                if (window.EMBEDDED_TOOL_INFO) {
                    console.log('‚úÖ Using tool info from index.html:', window.EMBEDDED_TOOL_INFO);
                    toolName = window.EMBEDDED_TOOL_INFO.toolName;
                    toolVersion = window.EMBEDDED_TOOL_INFO.toolVersion;
                } else {
                    console.log('‚ö†Ô∏è No embedded tool info, trying URL parameters or filename');
                    
                    // FALLBACK: Try URL parameters first
                    const urlParams = new URLSearchParams(window.location.search);
                    toolName = urlParams.get('tool');
                    toolVersion = urlParams.get('version') || 'free';
                    
                    // If no URL parameters, extract from filename
                    if (!toolName) {
                        const pathname = window.location.pathname;
                        const filename = pathname.split('/').pop();
                        console.log('üîç Parsing filename:', filename);
                        
                        // Extract tool name and version from filename patterns
                        if (filename.includes('claude-ai') || filename.includes('claude')) {
                            toolName = 'Claude.ai';
                            toolVersion = filename.includes('enterprise') ? 'enterprise' : 'free';
                            console.log('‚úÖ Detected Claude.ai tool, version:', toolVersion);
                        } else if (filename.includes('chatgpt')) {
                            toolName = 'ChatGPT';
                            toolVersion = filename.includes('enterprise') ? 'enterprise' : 'free';
                            console.log('‚úÖ Detected ChatGPT tool, version:', toolVersion);
                        } else if (filename.includes('copilot')) {
                            toolName = 'GitHub Copilot';
                            toolVersion = filename.includes('enterprise') ? 'enterprise' : 'free';
                            console.log('‚úÖ Detected Copilot tool, version:', toolVersion);
                        } else if (filename.includes('maestro')) {
                            toolName = 'Maestro Labs Notetaker';
                            toolVersion = filename.includes('enterprise') ? 'enterprise' : 'free';
                            console.log('‚úÖ Detected Maestro tool, version:', toolVersion);
                        } else {
                            toolName = 'ChatGPT';
                            toolVersion = 'free';
                            console.log('‚ö†Ô∏è Using fallback: ChatGPT Free');
                        }
                    }
                }
                
                // Now query database with the correct tool name and version
                const searchTerms = buildSearchTerms(toolName, toolVersion);
                console.log('üîç Querying database with search terms:', searchTerms);
                
                let toolData = null;
                for (const searchTerm of searchTerms) {
                    console.log(`üîç [TEMPLATE] Trying search term: "${searchTerm}"`);
                    
                    // Use enhanced search logic from index.html
                    const orderField = toolVersion === 'enterprise' ? 'name' : 'name';
                    const orderDirection = toolVersion === 'enterprise' ? 'desc' : 'asc';
                    
                    const { data: tools, error } = await supabase
                        .from('ai_tools')
                        .select('*')
                        .ilike('name', `%${searchTerm}%`)
                        .order(orderField, { ascending: orderDirection === 'asc' })
                        .limit(3); // Get multiple results to find best match

                    if (error) {
                        console.warn('‚ùå Supabase query error for term:', searchTerm, error);
                        continue;
                    }

                    if (tools && tools.length > 0) {
                        console.log(`üîç [TEMPLATE] Found ${tools.length} matches:`, tools.map(t => `${t.name} (${t.total_score})`));
                        
                        // Find the best match for the requested version (same logic as index.html)
                        let bestMatch = tools[0]; // Default to first
                        
                        for (const tool of tools) {
                            const toolNameLower = tool.name.toLowerCase();
                            const requestedVersion = toolVersion.toLowerCase();
                            
                            // Prioritize exact version match
                            if (requestedVersion === 'enterprise' && toolNameLower.includes('enterprise')) {
                                bestMatch = tool;
                                console.log(`‚úÖ [TEMPLATE] ENTERPRISE MATCH FOUND: ${tool.name} (score: ${tool.total_score})`);
                                break;
                            } else if (requestedVersion === 'free' && (toolNameLower.includes('free') || !toolNameLower.includes('enterprise'))) {
                                bestMatch = tool;
                                console.log(`‚úÖ [TEMPLATE] FREE MATCH FOUND: ${tool.name} (score: ${tool.total_score})`);
                                break;
                            }
                        }
                        
                        toolData = bestMatch;
                        console.log(`üéØ [TEMPLATE] SELECTED MATCH: ${bestMatch.name} (score: ${bestMatch.total_score})`);
                        break;
                    }
                }

                if (!toolData) {
                    console.warn('No tool data found for search terms:', searchTerms);
                    showError(`No assessment data found for: ${searchTerms.join(' or ')}`);
                    return;
                }

                console.log('üìã Final tool data being used:', toolData);

                // Generate all dynamic content
                generateSecurityCategories(toolData);
                populateExecutiveSummary(toolData);
                populateToolInformation(toolData);
                updateRiskMatrix(toolData);
                generateAzurePermissions(toolData);
                generateRecommendations(toolData);

            } catch (error) {
                console.error('Error loading security assessment:', error);
                showError('Failed to load security assessment data');
            }
        }

        // Generate security categories HTML based on your data structure
        function generateSecurityCategories(toolData) {
            const categoriesGrid = document.getElementById('securityCategoriesGrid');
            
            if (!categoriesGrid) {
                console.error('Categories grid not found');
                return;
            }

            // Extract scores from your data structure
            const scores = {
                dataStorage: toolData.data_storage_score || 0,
                trainingUsage: toolData.training_usage_score || 0,
                accessControls: toolData.access_controls_score || 0,
                complianceRisk: toolData.compliance_score || 0,
                vendorTransparency: toolData.vendor_transparency_score || 0
            };

            // Parse breakdown data (your JSON structure)
            let breakdownData = null;
            try {
                if (toolData.breakdown && typeof toolData.breakdown === 'string') {
                    breakdownData = JSON.parse(toolData.breakdown);
                } else if (toolData.breakdown && typeof toolData.breakdown === 'object') {
                    breakdownData = toolData.breakdown;
                }
            } catch (e) {
                console.warn('Could not parse breakdown data:', e);
            }

            console.log('Scores extracted:', scores);
            console.log('Breakdown data:', breakdownData);

            // Generate HTML for each category
            let categoriesHTML = '';
            
            Object.keys(scores).forEach(categoryKey => {
                const score = scores[categoryKey];
                const riskLevel = calculateRiskLevel(score);
                const riskClass = getRiskLevelClass(riskLevel);
                const categoryInfo = categoryDescriptions[categoryKey];
                const description = generateDescription(categoryKey, score, breakdownData);

                categoriesHTML += `
                    <div class="category-card ${riskClass}">
                        <div class="category-header">
                            <div class="category-name">${categoryInfo.name}</div>
                            <div class="category-score ${riskClass}">${riskLevel}</div>
                        </div>
                        <div class="category-description">
                            ${description}
                        </div>
                    </div>
                `;
            });

            // Update the grid
            categoriesGrid.innerHTML = categoriesHTML;
            
            console.log('Security categories generated successfully');
        }

        // Populate Executive Summary section
        function populateExecutiveSummary(toolData) {
            const totalScore = toolData.total_score || 0;
            const riskLevel = getRiskLevelFromScore(totalScore);
            
            // Update risk score display
            document.getElementById('riskScore').textContent = totalScore;
            document.getElementById('riskLevel').textContent = `${riskLevel} RISK`;
            document.getElementById('riskDescription').textContent = getRiskDescription(riskLevel, totalScore);
            
            // Apply risk level styling to the card
            const riskCard = document.getElementById('riskScoreCard');
            if (riskCard) {
                // Remove any existing risk classes
                riskCard.classList.remove('risk-low', 'risk-medium', 'risk-high', 'risk-critical');
                // Add the appropriate risk class
                riskCard.classList.add(`risk-${riskLevel.toLowerCase()}`);
            }
            
            // Generate Security Status
            const securityStatus = generateSecurityStatus(toolData, riskLevel);
            document.getElementById('securityStatusText').textContent = securityStatus;
            
            // Generate Compliance Impact
            const complianceImpact = generateComplianceImpact(toolData);
            document.getElementById('complianceImpactText').textContent = complianceImpact;
            
            // Generate Main Recommendation
            const mainRecommendation = generateMainRecommendation(toolData, riskLevel);
            document.getElementById('mainRecommendationText').textContent = mainRecommendation;
            
            // Generate Key Findings
            const keyFindings = generateKeyFindings(toolData);
            document.getElementById('keyFindings').innerHTML = keyFindings;
            
            console.log('Executive summary populated successfully');
        }

        // Populate Tool Information section
        function populateToolInformation(toolData) {
            const currentDate = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // Header information
            document.getElementById('headerToolName').textContent = toolData.name || 'Unknown Tool';
            const assessmentId = `ASS-${Date.now()}`;
            document.getElementById('headerAssessmentId').textContent = assessmentId;
            document.getElementById('headerGeneratedDate').textContent = currentDate;
            
            // Footer information
            document.getElementById('footerAssessmentId').textContent = assessmentId;
            document.getElementById('footerGeneratedDate').textContent = currentDate;
            
            // Next review date (3 months from now)
            const nextReview = new Date();
            nextReview.setMonth(nextReview.getMonth() + 3);
            document.getElementById('nextReviewDate').textContent = nextReview.toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            // Tool name and category
            document.getElementById('toolName').textContent = toolData.name || 'Unknown Tool';
            document.getElementById('toolCategory').textContent = toolData.category || 'AI Platform';
            
            // Generate tool icon from name
            const toolIcon = generateToolIcon(toolData.name);
            document.getElementById('toolIcon').textContent = toolIcon;
            
            // Tool information
            document.getElementById('primaryUseCase').textContent = 'Enterprise Productivity'; // Default - we'll add to DB later
            document.getElementById('dataClassification').textContent = 'Confidential'; // Default - we'll add to DB later
            document.getElementById('assessmentDate').textContent = currentDate;
            document.getElementById('riskCategory').textContent = toolData.category || 'AI Platform';
            document.getElementById('vendor').textContent = extractVendor(toolData.name);
            document.getElementById('licenseType').textContent = toolData.name.includes('Enterprise') ? 'Enterprise License' : 'Standard License';
            
            console.log('Tool information populated successfully');
        }

        // Update risk matrix display
        function updateRiskMatrix(toolData) {
            const totalScore = toolData.total_score || 0;
            const riskLevel = getRiskLevelFromScore(totalScore);
            
            // Update matrix description
            document.getElementById('matrixDescription').textContent = 
                `‚òÖ Current Risk Level: Score ${totalScore} falls in ${riskLevel} category`;
            
            // Update current risk cell highlighting (you can enhance this logic)
            const matrixCell = document.getElementById('currentRiskMatrixCell');
            if (matrixCell) {
                // Remove any existing classes and add current risk indicator
                matrixCell.className = `matrix-${riskLevel.toLowerCase()}`;
                matrixCell.innerHTML = `${riskLevel.toLowerCase().charAt(0).toUpperCase() + riskLevel.toLowerCase().slice(1)} ‚òÖ`;
            }
            
            console.log('Risk matrix updated successfully');
        }

        // Generate Azure permissions (placeholder for now)
        function generateAzurePermissions(toolData) {
            const permissionsHTML = `
                <div style="text-align: center; padding: 2rem; color: #64748b;">
                    <div style="margin-bottom: 1rem;">üîê Azure AD Integration Assessment</div>
                    <div style="font-size: 0.9rem;">
                        This section will be populated with Azure AD permissions analysis<br>
                        when integration is configured. Contact IT Security for setup.
                    </div>
                </div>
            `;
            
            document.getElementById('azurePermissions').innerHTML = permissionsHTML;
            console.log('Azure permissions section updated');
        }

        // Generate recommendations based on tool data
        function generateRecommendations(toolData) {
            const recommendations = [];
            const totalScore = toolData.total_score || 0;
            const riskLevel = getRiskLevelFromScore(totalScore);
            
            // Generate recommendations based on scores and risk levels
            if (toolData.compliance_score > 10) {
                recommendations.push({
                    title: 'PCI-DSS Compliance Verification',
                    priority: 'HIGH',
                    icon: 'üí≥',
                    description: 'Conduct comprehensive PCI-DSS compliance audit to ensure financial data handling meets regulatory requirements. Verify data encryption, access logging, and secure transmission protocols.',
                    timeline: '30 days',
                    owner: 'Security Team'
                });
            }
            
            if (toolData.compliance_score > 8) {
                recommendations.push({
                    title: 'SOX Controls Implementation',
                    priority: 'HIGH',
                    icon: 'üìä',
                    description: 'Implement Sarbanes-Oxley controls for financial reporting data processed through the AI tool. Establish audit trails, data integrity checks, and access accountability measures.',
                    timeline: '45 days',
                    owner: 'Compliance Team'
                });
            }
            
            if (toolData.data_storage_score > 8) {
                recommendations.push({
                    title: 'Enhanced Data Loss Prevention (DLP)',
                    priority: 'MEDIUM',
                    icon: 'üõ°Ô∏è',
                    description: 'Configure advanced DLP policies to monitor and prevent sensitive data from being inadvertently shared through AI interactions.',
                    timeline: '60 days',
                    owner: 'IT Security'
                });
            }
            
            if (riskLevel === 'HIGH' || riskLevel === 'MEDIUM') {
                recommendations.push({
                    title: 'AI Governance Committee',
                    priority: 'MEDIUM',
                    icon: 'üë•',
                    description: 'Create a cross-functional AI governance committee to oversee AI tool usage, establish usage policies, and conduct regular risk assessments.',
                    timeline: '90 days',
                    owner: 'Executive Team'
                });
            }
            
            recommendations.push({
                title: 'Usage Analytics Dashboard',
                priority: 'LOW',
                icon: 'üìà',
                description: 'Deploy comprehensive usage analytics to track AI tool utilization patterns, identify potential security anomalies, and generate compliance reports.',
                timeline: '120 days',
                owner: 'IT Operations'
            });
            
            // Generate HTML for recommendations
            const recommendationsHTML = recommendations.map(rec => `
                <div class="recommendation-card priority-${rec.priority.toLowerCase()}">
                    <div class="recommendation-header">
                        <div class="recommendation-title">${rec.title}</div>
                        <div class="priority-badge priority-${rec.priority.toLowerCase()}">${rec.priority}</div>
                    </div>
                    <div class="recommendation-text">
                        ${rec.icon} ${rec.description}
                        <br><br><strong>Timeline:</strong> ${rec.timeline} | <strong>Owner:</strong> ${rec.owner}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('recommendationsGrid').innerHTML = recommendationsHTML;
            console.log('Recommendations generated successfully');
        }

        // Helper functions - Updated to match your risk framework
        function getRiskLevelFromScore(score) {
            if (score >= 80) return 'CRITICAL';
            if (score >= 60) return 'HIGH';
            if (score >= 35) return 'MEDIUM';
            return 'LOW'; // 0-34 points
        }

        function getRiskDescription(riskLevel, score) {
            switch(riskLevel) {
                case 'CRITICAL':
                    return 'Immediate blocking required - critical security risks identified';
                case 'HIGH':
                    return 'Significant controls needed before use - high security risks';
                case 'MEDIUM':
                    return 'Standard enterprise controls required - moderate security risks';
                case 'LOW':
                default:
                    return 'Basic monitoring sufficient - acceptable risk level';
            }
        }

        function generateSecurityStatus(toolData, riskLevel) {
            if (riskLevel === 'HIGH' || riskLevel === 'CRITICAL') {
                return 'Tool poses significant security risks requiring immediate attention and enhanced controls before deployment.';
            } else if (riskLevel === 'MEDIUM') {
                return 'Tool meets basic security standards with some areas requiring attention for enterprise deployment.';
            } else {
                return 'Tool demonstrates acceptable security posture with standard enterprise controls and monitoring.';
            }
        }

        function generateComplianceImpact(toolData) {
            const complianceScore = toolData.compliance_score || 0;
            if (complianceScore > 15) {
                return 'Significant compliance gaps identified. HIPAA, PCI-DSS, and SOX verification required before handling regulated data.';
            } else if (complianceScore > 8) {
                return 'PCI-DSS and SOX compliance verification needed due to financial data classification and regulatory requirements.';
            } else {
                return 'Standard compliance controls applicable. Regular compliance monitoring and documentation recommended.';
            }
        }

        function generateMainRecommendation(toolData, riskLevel) {
            if (riskLevel === 'HIGH' || riskLevel === 'CRITICAL') {
                return 'Immediate security review and remediation required before deployment authorization.';
            } else if (riskLevel === 'MEDIUM') {
                return 'Implement enhanced monitoring and compliance controls before full deployment.';
            } else {
                return 'Standard deployment procedures with ongoing monitoring and periodic risk assessments.';
            }
        }

        function generateKeyFindings(toolData) {
            const findings = [];
            
            // First, try to use the dedicated notes field from database
            if (toolData.notes && toolData.notes.trim().length > 0) {
                // Split notes by common separators and add each as a finding
                const noteFindings = toolData.notes
                    .split(/[;|\n|‚Ä¢]/) // Split on semicolon, newline, or bullet points
                    .map(note => note.trim())
                    .filter(note => note.length > 10) // Filter out very short notes
                    .slice(0, 5); // Limit to 5 findings
                    
                if (noteFindings.length > 0) {
                    return '‚Ä¢ ' + noteFindings.join('<br>‚Ä¢ ');
                }
            }
            
            // Fallback: Extract critical findings from breakdown data (NO TRUNCATION)
            if (toolData.breakdown && toolData.breakdown.subScores) {
                const subScores = toolData.breakdown.subScores;
                
                // Look for critical findings in each category
                Object.keys(subScores).forEach(categoryKey => {
                    const category = subScores[categoryKey];
                    
                    Object.keys(category).forEach(subKey => {
                        const item = category[subKey];
                        if (item && item.note) {
                            const note = item.note.toLowerCase();
                            
                            // Extract critical/important findings based on keywords
                            if (note.includes('critical gap') || note.includes('critical:') || 
                                note.includes('hipaa') || note.includes('not compliant') ||
                                note.includes('indefinite retention') || note.includes('no enterprise') ||
                                note.includes('major compliance barriers') || note.includes('high gdpr risk') ||
                                note.includes('no audit trail') || note.includes('basic oauth only') ||
                                note.includes('unclear server locations') || note.includes('lacks enterprise-grade')) {
                                
                                // Add the full finding WITHOUT truncation
                                findings.push(item.note);
                            }
                        }
                    });
                });
            }
            
            // If no critical findings found, add general findings based on scores
            if (findings.length === 0) {
                if (toolData.total_score < 35) {
                    findings.push('Acceptable security controls with standard enterprise monitoring requirements');
                    findings.push('Regular assessment and compliance review recommended');
                } else {
                    findings.push('Enhanced security controls and compliance verification required');
                    findings.push('Detailed risk mitigation plan needed before deployment');
                }
            }
            
            // Limit to top 5 findings (but keep full text)
            const limitedFindings = findings.slice(0, 5);
            
            return '‚Ä¢ ' + limitedFindings.join('<br>‚Ä¢ ');
        }

        function generateToolIcon(toolName) {
            if (toolName.toLowerCase().includes('chatgpt')) return 'GPT';
            if (toolName.toLowerCase().includes('claude')) return 'CLD';
            if (toolName.toLowerCase().includes('copilot')) return 'CP';
            if (toolName.toLowerCase().includes('gemini')) return 'GEM';
            return 'AI';
        }

        function extractVendor(toolName) {
            if (toolName.toLowerCase().includes('chatgpt')) return 'OpenAI';
            if (toolName.toLowerCase().includes('claude')) return 'Anthropic';
            if (toolName.toLowerCase().includes('copilot')) return 'Microsoft/GitHub';
            if (toolName.toLowerCase().includes('gemini')) return 'Google';
            return 'Unknown Vendor';
        }

        // Show error message
        function showError(message) {
            const categoriesGrid = document.getElementById('securityCategoriesGrid');
            if (categoriesGrid) {
                categoriesGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #dc2626; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è Assessment Data Unavailable</div>
                        <div style="font-size: 0.9rem;">${message}</div>
                    </div>
                `;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing security assessment...');
            
            // Check if this is a free version and update header accordingly
            const isFreeVersion = window.EMBEDDED_TOOL_INFO?.isFreeVersion || false;
            const subtitleElement = document.getElementById('reportSubtitle');
            
            if (isFreeVersion && subtitleElement) {
                subtitleElement.innerHTML = 'Enterprise Security Analysis & Compliance Report<br><span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; margin-top: 0.5rem; display: inline-block;">üìÑ Free Version - Upgrade for detailed analysis</span>';
            }
            
            loadSecurityAssessment();
        });
    </script>
</body>
</html>