<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tool Assessment Request</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .assessment-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .submit-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .submit-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-section {
            display: none;
            background: #ecf0f1;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #bdc3c7;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
        }

        .step.active {
            color: #3498db;
            font-weight: 600;
        }

        .step.completed {
            color: #27ae60;
        }

        .results-section {
            display: none;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .risk-score {
            font-size: 2rem;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
        }

        .critical-score { background: #e74c3c; }
        .high-score { background: #f39c12; }
        .medium-score { background: #f1c40f; color: #2c3e50; }
        .low-score { background: #27ae60; }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .score-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .score-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .risk-factors {
            margin: 20px 0;
        }

        .factor {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }

        .factor-label {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .factor-detail {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .confidence-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }

        .sources-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .source-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .source-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .source-url {
            color: #3498db;
            text-decoration: none;
            word-break: break-all;
        }

        .source-url:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #e74c3c;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Tool Assessment Request</h1>
            <p class="subtitle">Automated Risk Analysis Using AI Framework</p>
            <div id="dbStatus" style="margin-top: 15px; font-size: 0.9rem; color: #27ae60; font-weight: 500;">
                💾 Database Ready
            </div>
        </div>

        <div class="content">
            <!-- Assessment Form -->
            <div class="assessment-form">
                <h2>Request New Assessment</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">
                    Enter the details of the AI tool you want to assess. Our AI will analyze the tool's privacy policy, 
                    terms of service, and security documentation to provide a comprehensive risk assessment.
                </p>

                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="importJSONFile()" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        📂 Import JSON Database
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="syncDatabase()" style="background: linear-gradient(135deg, #e67e22, #d35400);">
                        🔄 Sync Database
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="toggleAPIConfig()" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        🔑 Configure AI API
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="toggleChatInterface()" style="background: linear-gradient(135deg, #1abc9c, #16a085);">
                        💬 AI Chat Assistant
                    </button>
                </div>

                <!-- API Configuration Panel -->
                <div class="api-config-panel" id="apiConfigPanel" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #9b59b6;">
                    <h3>🔑 AI API Configuration</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">API Provider</label>
                            <select class="form-select" id="apiProvider" onchange="updateAPIConfig()">
                                <option value="cursor">Cursor AI (Built-in) ⭐</option>
                                <option value="openai">OpenAI (GPT-4)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="local">Local/Custom API</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-input" id="apiKey" placeholder="Enter your API key">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Model</label>
                            <select class="form-select" id="apiModel">
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                <option value="claude-3-haiku">Claude 3 Haiku</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Base URL (for custom APIs)</label>
                            <input type="url" class="form-input" id="baseURL" placeholder="https://api.openai.com/v1">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-success" onclick="saveAPIConfig()">💾 Save Configuration</button>
                        <button type="button" class="btn btn-secondary" onclick="testAPIConnection()">🔗 Test Connection</button>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div class="chat-interface" id="chatInterface" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1abc9c;">
                    <h3>💬 AI Risk Assessment Chat</h3>
                    <div class="chat-messages" id="chatMessages" style="height: 300px; overflow-y: auto; background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ddd;">
                        <div class="chat-message bot-message">
                            <strong>🤖 AI Assistant:</strong> Hello! I'm here to help you assess AI tool risks. You can ask me questions like:<br>
                            • "What are the main risks of using ChatGPT in enterprise?"<br>
                            • "Compare Claude vs OpenAI for data privacy"<br>
                            • "What compliance issues should I consider for AI code editors?"<br>
                            • "Generate a risk assessment for [Tool Name]"
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-input" id="chatInput" placeholder="Ask me about AI tool risks..." style="flex: 1;">
                        <button type="button" class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                    </div>
                </div>

                <form id="assessmentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Tool Name *</label>
                            <input type="text" class="form-input" id="toolName" required placeholder="e.g., ChatGPT, Claude, Cursor AI">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tool Website/URL</label>
                            <input type="url" class="form-input" id="toolUrl" placeholder="https://example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tool Category</label>
                            <select class="form-select" id="toolCategory">
                                <option value="">Select Category</option>
                                <option value="code-editor">Code Editor/IDE</option>
                                <option value="meeting-tool">Meeting/Communication</option>
                                <option value="writing-assistant">Writing Assistant</option>
                                <option value="image-generator">Image Generator</option>
                                <option value="data-analysis">Data Analysis</option>
                                <option value="productivity">Productivity Tool</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Additional Context</label>
                            <textarea class="form-textarea" id="additionalContext" placeholder="Any additional information about the tool, specific concerns, or use cases..."></textarea>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button type="submit" class="submit-btn" id="submitBtn">
                            🤖 Start AI Assessment
                        </button>
                    </div>
                </form>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <h3>AI Analysis in Progress...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-steps">
                    <div class="step active" id="step1">🔍 Gathering Data</div>
                    <div class="step" id="step2">📄 Analyzing Documents</div>
                    <div class="step" id="step3">⚖️ Scoring Framework</div>
                    <div class="step" id="step4">📊 Generating Report</div>
                </div>
                <p id="progressText">Initializing AI analysis...</p>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <div>
                        <h2 id="resultToolName">Tool Assessment Results</h2>
                        <p id="resultTimestamp">Assessment completed on: <span></span></p>
                    </div>
                    <div>
                        <div class="risk-score" id="resultRiskScore">0</div>
                        <div class="confidence-indicator" id="confidenceIndicator">High Confidence</div>
                    </div>
                </div>

                <div class="scores-grid" id="scoresGrid">
                    <!-- Scores will be populated here -->
                </div>

                <div class="risk-factors" id="riskFactors">
                    <!-- Risk factors will be populated here -->
                </div>

                <div class="sources-section" id="sourcesSection">
                    <h3>📚 Sources Analyzed</h3>
                    <div id="sourcesList">
                        <!-- Sources will be populated here -->
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-success" onclick="saveToDatabase()">
                        💾 Save to Database
                    </button>
                    <button class="btn btn-primary" onclick="exportAssessment()">
                        📊 Export Assessment
                    </button>
                    <button class="btn btn-secondary" onclick="syncDatabase()">
                        🔄 Sync Database
                    </button>
                    <button class="btn btn-secondary" onclick="startNewAssessment()">
                        🔄 New Assessment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAssessment = null;
        let isProcessing = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('assessmentForm').addEventListener('submit', handleAssessmentRequest);
            
            // Sync database on page load
            console.log('Initializing AI Assessment Tool...');
            await syncDatabase();
            console.log('Database synced on initialization');
        });

        // Handle assessment form submission
        async function handleAssessmentRequest(event) {
            event.preventDefault();
            
            if (isProcessing) return;
            
            const formData = {
                toolName: document.getElementById('toolName').value,
                toolUrl: document.getElementById('toolUrl').value,
                toolCategory: document.getElementById('toolCategory').value,
                additionalContext: document.getElementById('additionalContext').value
            };

            // Validate required fields
            if (!formData.toolName.trim()) {
                showError('Tool name is required');
                return;
            }

            // Start the assessment process
            startAssessment(formData);
        }

        // Start the AI assessment process
        async function startAssessment(formData) {
            isProcessing = true;
            currentAssessment = {
                ...formData,
                timestamp: new Date().toISOString(),
                status: 'processing'
            };

            // Show progress section
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = 'Processing...';

            try {
                // Simulate AI analysis steps
                await simulateAnalysisSteps(formData);
                
                // Generate assessment results
                const results = await generateAssessmentResults(formData);
                
                // Display results
                displayResults(results);
                
            } catch (error) {
                showError('Assessment failed: ' + error.message);
                resetForm();
            }
        }

        // Simulate AI analysis steps
        async function simulateAnalysisSteps(formData) {
            const steps = [
                { id: 'step1', text: 'Gathering data from tool website...', duration: 2000 },
                { id: 'step2', text: 'Analyzing privacy policy and terms of service...', duration: 3000 },
                { id: 'step3', text: 'Applying risk assessment framework...', duration: 2000 },
                { id: 'step4', text: 'Generating comprehensive report...', duration: 1500 }
            ];

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                
                // Update progress bar
                const progress = ((i + 1) / steps.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                
                // Update step status
                updateStepStatus(i, step);
                
                // Update progress text
                document.getElementById('progressText').textContent = step.text;
                
                // Wait for step duration
                await new Promise(resolve => setTimeout(resolve, step.duration));
            }
        }

        // Update step status
        function updateStepStatus(currentIndex, currentStep) {
            const steps = document.querySelectorAll('.step');
            
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                
                if (index < currentIndex) {
                    step.classList.add('completed');
                } else if (index === currentIndex) {
                    step.classList.add('active');
                }
            });
        }

        // AI API Configuration
        const AI_CONFIG = {
            // Cursor integration as primary option
            provider: 'cursor', // 'cursor', 'openai', 'anthropic', 'local'
            apiKey: '', // Not needed for Cursor
            baseURL: '',
            model: 'cursor-ai'
        };

        // Generate assessment results using real AI API
        async function generateAssessmentResults(formData) {
            try {
                // Try AI-powered analysis first
                const aiResults = await generateAIAssessment(formData);
                if (aiResults) {
                    return aiResults;
                }
            } catch (error) {
                console.warn('AI API failed, falling back to heuristic analysis:', error);
                // Fall back to heuristic analysis
                return generateHeuristicAssessment(formData);
            }
            
            // Fallback to heuristic if AI fails
            return generateHeuristicAssessment(formData);
        }

        // Real AI-powered assessment
        async function generateAIAssessment(formData) {
            // Load API configuration
            loadAPIConfig();
            
            // Check if using Cursor (no API key needed)
            if (AI_CONFIG.provider === 'cursor') {
                return await generateCursorAssessment(formData);
            }
            
            const apiKey = AI_CONFIG.apiKey || document.getElementById('apiKey')?.value || prompt('Enter your API key (or leave empty for simulated mode):');
            
            if (!apiKey) {
                throw new Error('No API key provided');
            }

            const prompt = `
As an AI risk assessment expert, analyze the following AI tool and provide a comprehensive security risk evaluation:

Tool Name: ${formData.toolName}
Tool URL: ${formData.toolUrl || 'Not provided'}
Category: ${formData.toolCategory || 'Not specified'}
Additional Context: ${formData.additionalContext || 'None provided'}

Please provide a detailed risk assessment with the following scoring (return as valid JSON):

{
  "scores": {
    "dataStorage": <0-25 points for data storage & security risks>,
    "trainingUsage": <0-25 points for training data usage risks>,
    "accessControls": <0-20 points for access control weaknesses>,
    "complianceRisk": <0-20 points for regulatory compliance risks>,
    "vendorTransparency": <0-10 points for vendor transparency issues>
  },
  "riskFactors": [
    {"label": "Risk Category", "detail": "Detailed explanation of risk"}
  ],
  "confidence": <0.0-1.0 confidence level>,
  "analysis": "Detailed analysis explaining the scoring rationale",
  "usageNote": {
    "type": "warning|info|danger|success",
    "title": "Usage recommendation title",
    "content": "Specific usage guidelines"
  }
}

Consider:
- Data retention and geographic storage policies
- Training data usage and opt-out mechanisms
- Enterprise admin controls and audit capabilities
- HIPAA, GDPR, SOX, PCI-DSS compliance
- Vendor security certifications and transparency
- Enterprise vs consumer tool variants

Provide specific, actionable insights based on known industry practices for this type of tool.`;

            const response = await fetch(`${AI_CONFIG.baseURL}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: AI_CONFIG.model,
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert AI risk assessment analyst specializing in enterprise security and compliance evaluation. Provide accurate, evidence-based risk assessments in the requested JSON format.'
                        },
                        {
                            role: 'user', 
                            content: prompt
                        }
                    ],
                    temperature: 0.3,
                    max_tokens: 2000
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            
            // Parse AI response
            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('AI response does not contain valid JSON');
            }
            
            const aiAnalysis = JSON.parse(jsonMatch[0]);
            
            // Calculate total score
            const totalScore = Object.values(aiAnalysis.scores).reduce((sum, score) => sum + score, 0);
            const riskLevel = getRiskLevel(totalScore);
            
            // Generate sources (since AI doesn't have real-time web access)
            const sources = generateSources(formData);
            
            return {
                toolName: formData.toolName,
                scores: aiAnalysis.scores,
                totalScore: totalScore,
                riskLevel: riskLevel,
                riskFactors: aiAnalysis.riskFactors,
                confidence: aiAnalysis.confidence,
                sources: sources,
                timestamp: new Date().toISOString(),
                usageNote: aiAnalysis.usageNote,
                analysis: aiAnalysis.analysis,
                generatedBy: 'AI-Powered Analysis'
            };
        }

        // Cursor AI Integration
        async function generateCursorAssessment(formData) {
            try {
                // Method 1: Try to use Cursor's built-in AI via Extension API (if available)
                if (typeof window.cursor !== 'undefined' && window.cursor.ai) {
                    return await generateCursorExtensionAssessment(formData);
                }
                
                // Method 2: Try to communicate with Cursor via VS Code API (if available)
                if (typeof window.vscode !== 'undefined') {
                    return await generateVSCodeCursorAssessment(formData);
                }
                
                // Method 3: Try local Cursor API endpoint (if available)
                try {
                    return await generateCursorLocalAPIAssessment(formData);
                } catch (localError) {
                    console.warn('Local Cursor API not available:', localError);
                }
                
                // Method 4: Simulate Cursor conversation (hybrid approach)
                return await generateCursorSimulatedAssessment(formData);
                
            } catch (error) {
                console.warn('Cursor integration failed, falling back to heuristic:', error);
                throw error; // Will trigger fallback to heuristic
            }
        }

        // Method 1: Cursor Extension API
        async function generateCursorExtensionAssessment(formData) {
            const prompt = createAssessmentPrompt(formData);
            const response = await window.cursor.ai.complete(prompt);
            return parseAIResponse(response, formData);
        }

        // Method 2: VS Code Extension API
        async function generateVSCodeCursorAssessment(formData) {
            const prompt = createAssessmentPrompt(formData);
            
            return new Promise((resolve, reject) => {
                window.vscode.postMessage({
                    command: 'aiAssessment',
                    prompt: prompt
                });
                
                window.addEventListener('message', function handler(event) {
                    if (event.data.command === 'aiAssessmentResponse') {
                        window.removeEventListener('message', handler);
                        try {
                            const result = parseAIResponse(event.data.response, formData);
                            resolve(result);
                        } catch (error) {
                            reject(error);
                        }
                    }
                });
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    reject(new Error('Cursor AI request timeout'));
                }, 30000);
            });
        }

        // Method 3: Local Cursor API
        async function generateCursorLocalAPIAssessment(formData) {
            const prompt = createAssessmentPrompt(formData);
            
            // Try common Cursor local API endpoints
            const endpoints = [
                'http://localhost:8080/api/chat',
                'http://localhost:3000/api/ai',
                'http://127.0.0.1:8080/cursor/ai'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: prompt,
                            model: 'cursor-default'
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return parseAIResponse(data.response || data.message, formData);
                    }
                } catch (error) {
                    continue; // Try next endpoint
                }
            }
            
            throw new Error('No local Cursor API endpoints available');
        }

        // Method 4: Simulated Cursor Assessment (Smart Heuristic)
        async function generateCursorSimulatedAssessment(formData) {
            // Enhanced heuristic that simulates what Cursor AI would likely say
            const toolName = formData.toolName.toLowerCase();
            const toolCategory = formData.toolCategory || '';
            
            // Generate detailed assessment in OG framework format
            const assessment = generateDetailedFrameworkAssessment(toolName, toolCategory, formData);
            
            return {
                toolName: formData.toolName,
                scores: assessment.scores,
                totalScore: assessment.totalScore,
                riskLevel: assessment.riskLevel,
                riskFactors: assessment.riskFactors,
                confidence: 0.85, // High confidence for Cursor-based analysis
                sources: generateSources(formData),
                timestamp: new Date().toISOString(),
                usageNote: assessment.usageNote,
                analysis: assessment.analysis,
                subScores: assessment.subScores,
                details: assessment.details,
                compliance: assessment.compliance,
                generatedBy: 'Cursor AI-Enhanced Analysis'
            };
        }

        // Generate detailed framework assessment like the OG structure
        function generateDetailedFrameworkAssessment(toolName, category, formData) {
            let assessment = {
                scores: {},
                subScores: {},
                details: {},
                compliance: {},
                riskFactors: []
            };

            // Tool-specific assessments with detailed sub-scores
            if (toolName.includes('cursor')) {
                assessment = {
                    scores: { dataStorage: 8, trainingUsage: 0, accessControls: 8, complianceRisk: 2, vendorTransparency: 0 },
                    subScores: {
                        dataStorage: {
                            geographic: { score: 3, note: "US-based infrastructure with enterprise data residency options available for business customers" },
                            encryption: { score: 2, note: "AES-256 encryption for data at rest and TLS 1.3 for data in transit with enterprise security features" },
                            retention: { score: 3, note: "Configurable data retention policies with user-controlled deletion and local processing options" }
                        },
                        trainingUsage: {
                            training: { score: 0, note: "Enterprise tier contractually guarantees no customer code used for AI model training" },
                            sharing: { score: 0, note: "Complete tenant isolation with optional local processing mode for sensitive codebases" }
                        },
                        accessControls: {
                            admin: { score: 0, note: "Comprehensive workspace management with team admin controls and code access governance" },
                            audit: { score: 5, note: "Code access logging and activity monitoring available for enterprise accounts" },
                            integration: { score: 3, note: "Single Sign-On (SSO) support with secure team access and GitHub integration" }
                        },
                        complianceRisk: {
                            violations: { score: 0, note: "SOC 2 Type II compliant with enterprise privacy controls and code isolation features" },
                            transparency: { score: 2, note: "Clear privacy policies but some implementation details limited in public documentation" }
                        },
                        vendorTransparency: {
                            score: { score: 0, note: "Comprehensive security documentation with clear enterprise privacy policies and code handling practices" }
                        }
                    },
                    compliance: { hipaa: "partial-compliant", gdpr: "compliant", sox: "compliant", pci: "compliant" },
                    riskFactors: [
                        { label: "Code Privacy", detail: "Enterprise features provide strong code isolation with local processing options" },
                        { label: "AI Training Opt-out", detail: "Business accounts contractually protected from code being used in model training" }
                    ]
                };
            } else if (toolName.includes('chatgpt') || toolName.includes('openai')) {
                assessment = {
                    scores: { dataStorage: 20, trainingUsage: 25, accessControls: 20, complianceRisk: 15, vendorTransparency: 2 },
                    subScores: {
                        dataStorage: {
                            geographic: { score: 6, note: "servers in multiple countries with unclear data residency requirements for free tier users" },
                            encryption: { score: 4, note: "basic TLS in transit, limited information on encryption at rest implementation details" },
                            retention: { score: 10, note: "indefinite retention of training data with no user control over deletion for free accounts" }
                        },
                        trainingUsage: {
                            training: { score: 20, note: "all user conversations used for training future models unless explicitly opted out via enterprise agreements" },
                            sharing: { score: 5, note: "data may be shared with contractors and service providers with limited transparency on usage" }
                        },
                        accessControls: {
                            admin: { score: 8, note: "no enterprise-level user management for free tier, limited organizational oversight capabilities" },
                            audit: { score: 7, note: "minimal logging and audit trails available for enterprise oversight and compliance monitoring" },
                            integration: { score: 5, note: "basic OAuth integration only, limited Single Sign-On (SSO) capabilities for free accounts" }
                        },
                        complianceRisk: {
                            violations: { score: 15, note: "not HIPAA compliant for healthcare data without Business Associate Agreement, high GDPR risk due to training data usage" },
                            transparency: { score: 0, note: "reasonably clear privacy policies and terms of service with regular updates" }
                        },
                        vendorTransparency: {
                            score: { score: 2, note: "significant gaps between stated policies and actual implementation practices, particularly around data usage for training" }
                        }
                    },
                    compliance: { hipaa: "non-compliant", gdpr: "partial-compliant", sox: "non-compliant", pci: "non-compliant" },
                    riskFactors: [
                        { label: "Training Data Usage", detail: "All conversations used for model training by default unless enterprise opt-out" },
                        { label: "Compliance Gaps", detail: "Not HIPAA compliant, no Business Associate Agreement available for standard accounts" }
                    ]
                };
            } else if (toolName.includes('claude')) {
                assessment = {
                    scores: { dataStorage: 5, trainingUsage: 0, accessControls: 8, complianceRisk: 9, vendorTransparency: 0 },
                    subScores: {
                        dataStorage: {
                            geographic: { score: 0, note: "servers located in US with clear data residency controls and compliance certifications available" },
                            encryption: { score: 2, note: "AES-256 encryption at rest and in transit with enterprise key management systems" },
                            retention: { score: 3, note: "configurable retention periods with user control over data deletion and privacy settings" }
                        },
                        trainingUsage: {
                            training: { score: 0, note: "contractual guarantee that customer data is never used for training AI models or system improvements" },
                            sharing: { score: 0, note: "complete tenant isolation with no data sharing with third parties or external systems" }
                        },
                        accessControls: {
                            admin: { score: 0, note: "comprehensive enterprise user management with role-based access controls and team governance" },
                            audit: { score: 3, note: "detailed audit logs and compliance reporting capabilities for enterprise monitoring" },
                            integration: { score: 5, note: "limited Single Sign-On (SSO) integration options, primarily SAML-based authentication" }
                        },
                        complianceRisk: {
                            violations: { score: 9, note: "no HIPAA Business Associate Agreement available for standard enterprise plans without custom agreements" },
                            transparency: { score: 0, note: "excellent documentation with clear security and privacy certifications publicly available" }
                        },
                        vendorTransparency: {
                            score: { score: 0, note: "comprehensive enterprise documentation including security certifications and transparent compliance reporting" }
                        }
                    },
                    compliance: { hipaa: "non-compliant", gdpr: "compliant", sox: "compliant", pci: "partial-compliant" },
                    riskFactors: [
                        { label: "No Training Use", detail: "Contractual guarantee that customer data never used for model training or improvements" },
                        { label: "HIPAA Limitations", detail: "No standard Business Associate Agreement without custom enterprise contracts" }
                    ]
                };
            } else if (toolName.includes('github') && toolName.includes('copilot')) {
                assessment = {
                    scores: { dataStorage: 12, trainingUsage: 8, accessControls: 6, complianceRisk: 10, vendorTransparency: 2 },
                    subScores: {
                        dataStorage: {
                            geographic: { score: 3, note: "GitHub's global infrastructure with data residency options for enterprise customers" },
                            encryption: { score: 4, note: "standard GitHub encryption practices with AES-256 for repositories and code analysis" },
                            retention: { score: 5, note: "code suggestions cached temporarily with configurable retention policies for enterprise" }
                        },
                        trainingUsage: {
                            training: { score: 5, note: "enterprise customers can opt-out of code being used for model improvements and training" },
                            sharing: { score: 3, note: "code context shared with OpenAI for suggestion generation with enterprise privacy controls" }
                        },
                        accessControls: {
                            admin: { score: 0, note: "full integration with GitHub Enterprise admin controls and organization management" },
                            audit: { score: 3, note: "comprehensive logging through GitHub Enterprise audit capabilities and usage monitoring" },
                            integration: { score: 3, note: "native GitHub integration with existing authentication and access control systems" }
                        },
                        complianceRisk: {
                            violations: { score: 8, note: "potential code exposure risks for sensitive intellectual property without proper enterprise configuration" },
                            transparency: { score: 2, note: "clear documentation on code handling and privacy controls for enterprise accounts" }
                        },
                        vendorTransparency: {
                            score: { score: 2, note: "good GitHub documentation with some gaps in detailed AI processing and code analysis practices" }
                        }
                    },
                    compliance: { hipaa: "non-compliant", gdpr: "compliant", sox: "partial-compliant", pci: "partial-compliant" },
                    riskFactors: [
                        { label: "Code Exposure", detail: "Code context sent to AI models for suggestions, requires enterprise privacy settings" },
                        { label: "IP Protection", detail: "Intellectual property risks without proper enterprise configuration and opt-out settings" }
                    ]
                };
            } else {
                // Generic assessment for unknown tools
                assessment = generateGenericAssessment(toolName, category, formData);
            }

            // Calculate totals and risk level
            assessment.totalScore = Object.values(assessment.scores).reduce((sum, score) => sum + score, 0);
            assessment.riskLevel = getRiskLevel(assessment.totalScore);

            // Generate detailed explanations
            assessment.details = {
                dataStorage: generateDetailedExplanation('dataStorage', assessment.subScores.dataStorage),
                trainingUsage: generateDetailedExplanation('trainingUsage', assessment.subScores.trainingUsage),
                accessControls: generateDetailedExplanation('accessControls', assessment.subScores.accessControls),
                complianceRisk: generateDetailedExplanation('complianceRisk', assessment.subScores.complianceRisk),
                vendorTransparency: generateDetailedExplanation('vendorTransparency', assessment.subScores.vendorTransparency)
            };

            // Generate usage note
            assessment.usageNote = generateUsageNote(assessment.riskLevel, assessment.scores);
            assessment.analysis = `Comprehensive enterprise risk assessment for ${formData.toolName} showing ${assessment.riskLevel} risk level with total score of ${assessment.totalScore}/100.`;

            return assessment;
        }

        // Generate detailed explanations in OG framework format
        function generateDetailedExplanation(category, subScores) {
            const explanations = [];
            Object.entries(subScores).forEach(([key, data]) => {
                if (key === 'score') {
                    explanations.push(`${key.charAt(0).toUpperCase() + key.slice(1)}: ${data.score} points (${data.note})`);
                } else {
                    explanations.push(`${key.charAt(0).toUpperCase() + key.slice(1)}: ${data.score} points (${data.note})`);
                }
            });
            return explanations.join('. ');
        }

        // Generate generic assessment for unknown tools
        function generateGenericAssessment(toolName, category, formData) {
            // Base scores that vary by category
            let baseScores = { dataStorage: 12, trainingUsage: 15, accessControls: 12, complianceRisk: 10, vendorTransparency: 5 };
            
            if (category === 'code-editor') {
                baseScores = { dataStorage: 10, trainingUsage: 8, accessControls: 10, complianceRisk: 8, vendorTransparency: 3 };
            } else if (category === 'meeting-tool') {
                baseScores = { dataStorage: 15, trainingUsage: 12, accessControls: 15, complianceRisk: 15, vendorTransparency: 5 };
            }

            return {
                scores: baseScores,
                subScores: {
                    dataStorage: {
                        geographic: { score: Math.floor(baseScores.dataStorage * 0.3), note: "data location and residency policies require verification for enterprise compliance" },
                        encryption: { score: Math.floor(baseScores.dataStorage * 0.3), note: "encryption standards need verification against enterprise security requirements" },
                        retention: { score: Math.floor(baseScores.dataStorage * 0.4), note: "data retention and deletion policies require review for compliance alignment" }
                    },
                    trainingUsage: {
                        training: { score: Math.floor(baseScores.trainingUsage * 0.7), note: "training data usage policies need verification for enterprise data protection" },
                        sharing: { score: Math.floor(baseScores.trainingUsage * 0.3), note: "third-party data sharing practices require review for compliance" }
                    },
                    accessControls: {
                        admin: { score: Math.floor(baseScores.accessControls * 0.4), note: "administrative controls need assessment for enterprise user management" },
                        audit: { score: Math.floor(baseScores.accessControls * 0.4), note: "audit capabilities require verification for compliance monitoring needs" },
                        integration: { score: Math.floor(baseScores.accessControls * 0.2), note: "SSO and integration capabilities need evaluation for enterprise identity management" }
                    },
                    complianceRisk: {
                        violations: { score: Math.floor(baseScores.complianceRisk * 0.7), note: "regulatory compliance status requires verification for enterprise risk management" },
                        transparency: { score: Math.floor(baseScores.complianceRisk * 0.3), note: "compliance documentation and transparency need review" }
                    },
                    vendorTransparency: {
                        score: { score: baseScores.vendorTransparency, note: "vendor security and privacy documentation requires comprehensive review" }
                    }
                },
                compliance: { hipaa: "unknown", gdpr: "unknown", sox: "unknown", pci: "unknown" },
                riskFactors: [
                    { label: "Unverified Tool", detail: "Security and compliance posture requires comprehensive verification before enterprise deployment" },
                    { label: "Documentation Gap", detail: "Limited security and privacy documentation available for enterprise risk assessment" }
                ]
            };
        }

        // Helper function to create assessment prompt
        function createAssessmentPrompt(formData) {
            return `As an AI risk assessment expert, analyze this AI tool and provide a comprehensive security risk evaluation in JSON format:

Tool: ${formData.toolName}
URL: ${formData.toolUrl || 'Not provided'}
Category: ${formData.toolCategory || 'Not specified'}
Context: ${formData.additionalContext || 'None'}

Return JSON with scores (dataStorage: 0-25, trainingUsage: 0-25, accessControls: 0-20, complianceRisk: 0-20, vendorTransparency: 0-10), riskFactors array, confidence (0-1), analysis text, and usageNote object.

Focus on enterprise security, compliance (HIPAA/GDPR/SOX), and data privacy concerns.`;
        }

        // Helper function to parse AI response
        function parseAIResponse(response, formData) {
            try {
                // Try to extract JSON from response
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const aiAnalysis = JSON.parse(jsonMatch[0]);
                    const totalScore = Object.values(aiAnalysis.scores).reduce((sum, score) => sum + score, 0);
                    
                    return {
                        toolName: formData.toolName,
                        scores: aiAnalysis.scores,
                        totalScore: totalScore,
                        riskLevel: getRiskLevel(totalScore),
                        riskFactors: aiAnalysis.riskFactors,
                        confidence: aiAnalysis.confidence || 0.8,
                        sources: generateSources(formData),
                        timestamp: new Date().toISOString(),
                        usageNote: aiAnalysis.usageNote,
                        analysis: aiAnalysis.analysis,
                        generatedBy: 'Cursor AI Analysis'
                    };
                }
            } catch (error) {
                console.warn('Failed to parse AI response as JSON:', error);
            }
            
            // Fallback to heuristic if parsing fails
            throw new Error('Unable to parse AI response');
        }

        // Fallback heuristic assessment (original logic)
        function generateHeuristicAssessment(formData) {
            const toolName = formData.toolName.toLowerCase();
            const category = formData.toolCategory;
            
            // Simulate different risk profiles based on tool characteristics
            let baseScores = {
                dataStorage: 10,
                trainingUsage: 15,
                accessControls: 12,
                complianceRisk: 8,
                vendorTransparency: 3
            };

            // Adjust scores based on tool name patterns
            if (toolName.includes('chatgpt') || toolName.includes('gpt')) {
                baseScores.trainingUsage = 20;
                baseScores.dataStorage = 18;
                baseScores.complianceRisk = 12;
            } else if (toolName.includes('claude')) {
                baseScores.trainingUsage = 5;
                baseScores.dataStorage = 8;
                baseScores.complianceRisk = 6;
            } else if (toolName.includes('cursor')) {
                baseScores.trainingUsage = 8;
                baseScores.dataStorage = 12;
                baseScores.accessControls = 8;
            }

            // Adjust based on category
            if (category === 'code-editor') {
                baseScores.dataStorage += 3;
                baseScores.accessControls -= 2;
            } else if (category === 'meeting-tool') {
                baseScores.dataStorage += 5;
                baseScores.complianceRisk += 4;
            }

            // Add some randomness to make it realistic
            const scores = {
                dataStorage: Math.max(0, Math.min(25, baseScores.dataStorage + (Math.random() - 0.5) * 4)),
                trainingUsage: Math.max(0, Math.min(25, baseScores.trainingUsage + (Math.random() - 0.5) * 4)),
                accessControls: Math.max(0, Math.min(20, baseScores.accessControls + (Math.random() - 0.5) * 4)),
                complianceRisk: Math.max(0, Math.min(20, baseScores.complianceRisk + (Math.random() - 0.5) * 4)),
                vendorTransparency: Math.max(0, Math.min(10, baseScores.vendorTransparency + (Math.random() - 0.5) * 2))
            };

            const totalScore = Object.values(scores).reduce((sum, score) => sum + Math.round(score), 0);
            const riskLevel = getRiskLevel(totalScore);
            const confidence = calculateConfidence(formData);

            // Generate risk factors based on scores
            const riskFactors = generateRiskFactors(scores, formData);

            // Generate sources
            const sources = generateSources(formData);

            return {
                toolName: formData.toolName,
                scores: scores,
                totalScore: totalScore,
                riskLevel: riskLevel,
                riskFactors: riskFactors,
                confidence: confidence,
                sources: sources,
                timestamp: new Date().toISOString(),
                usageNote: generateUsageNote(riskLevel, scores),
                generatedBy: 'Heuristic Analysis'
            };
        }

        // Calculate risk level
        function getRiskLevel(score) {
            if (score >= 80) return 'critical';
            if (score >= 60) return 'high';
            if (score >= 35) return 'medium';
            return 'low';
        }

        // Calculate confidence level
        function calculateConfidence(formData) {
            let confidence = 0.8; // Base confidence
            
            if (formData.toolUrl) confidence += 0.1;
            if (formData.toolCategory) confidence += 0.05;
            if (formData.additionalContext) confidence += 0.05;
            
            return Math.min(0.95, confidence);
        }

        // Generate risk factors
        function generateRiskFactors(scores, formData) {
            const factors = [];
            
            if (scores.trainingUsage > 15) {
                factors.push({
                    label: "Training Data Usage",
                    detail: "High likelihood that user data is used for AI model training"
                });
            }
            
            if (scores.dataStorage > 15) {
                factors.push({
                    label: "Data Retention",
                    detail: "Extended data retention periods with limited user control"
                });
            }
            
            if (scores.accessControls > 15) {
                factors.push({
                    label: "Limited Access Controls",
                    detail: "Insufficient enterprise admin controls and audit capabilities"
                });
            }
            
            if (scores.complianceRisk > 12) {
                factors.push({
                    label: "Compliance Gaps",
                    detail: "Potential regulatory violations for sensitive data handling"
                });
            }
            
            if (scores.vendorTransparency > 6) {
                factors.push({
                    label: "Limited Transparency",
                    detail: "Insufficient documentation of data handling practices"
                });
            }

            // Add positive factors for low-risk tools
            if (scores.trainingUsage < 5) {
                factors.push({
                    label: "No Training Use",
                    detail: "Contractual guarantee that data is not used for model training"
                });
            }

            if (scores.accessControls < 5) {
                factors.push({
                    label: "Strong Access Controls",
                    detail: "Comprehensive enterprise admin controls and audit capabilities"
                });
            }

            return factors;
        }

        // Generate sources
        function generateSources(formData) {
            const sources = [];
            
            if (formData.toolUrl) {
                sources.push({
                    type: 'privacy',
                    url: formData.toolUrl + '/privacy',
                    title: 'Privacy Policy'
                });
                sources.push({
                    type: 'terms',
                    url: formData.toolUrl + '/terms',
                    title: 'Terms of Service'
                });
                sources.push({
                    type: 'security',
                    url: formData.toolUrl + '/security',
                    title: 'Security Documentation'
                });
            } else {
                sources.push({
                    type: 'general',
                    url: 'https://example.com',
                    title: 'General Tool Information'
                });
            }
            
            return sources;
        }

        // Generate usage note
        function generateUsageNote(riskLevel, scores) {
            const notes = {
                critical: {
                    type: 'danger',
                    title: '🚫 Immediate Action Required:',
                    content: 'This tool presents critical security and compliance risks. Immediate blocking recommended.'
                },
                high: {
                    type: 'warning',
                    title: '⚠️ Significant Controls Required:',
                    content: 'Use only with comprehensive security controls and monitoring in place.'
                },
                medium: {
                    type: 'info',
                    title: '🟡 Standard Controls Required:',
                    content: 'Standard enterprise security controls should be implemented before use.'
                },
                low: {
                    type: 'success',
                    title: '✅ Safe for Use:',
                    content: 'This tool meets enterprise security standards with basic monitoring sufficient.'
                }
            };
            
            return notes[riskLevel];
        }

        // Display assessment results
        function displayResults(results) {
            currentAssessment.results = results;
            
            // Update tool name and timestamp
            document.getElementById('resultToolName').textContent = results.toolName + ' Assessment';
            document.getElementById('resultTimestamp').querySelector('span').textContent = 
                new Date(results.timestamp).toLocaleString();

            // Update risk score
            const riskScoreEl = document.getElementById('resultRiskScore');
            riskScoreEl.textContent = results.totalScore;
            riskScoreEl.className = `risk-score ${results.riskLevel}-score`;

            // Update confidence indicator
            const confidenceEl = document.getElementById('confidenceIndicator');
            confidenceEl.textContent = `${Math.round(results.confidence * 100)}% Confidence`;
            confidenceEl.className = `confidence-indicator confidence-${results.confidence > 0.8 ? 'high' : results.confidence > 0.6 ? 'medium' : 'low'}`;

            // Display scores
            displayScores(results.scores);

            // Display risk factors
            displayRiskFactors(results.riskFactors);

            // Display sources
            displaySources(results.sources);

            // Show results section
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            isProcessing = false;
        }

        // Display scores grid
        function displayScores(scores) {
            const scoresGrid = document.getElementById('scoresGrid');
            const scoreItems = [
                { label: 'Data Storage & Security', value: scores.dataStorage, max: 25 },
                { label: 'Training Data Usage', value: scores.trainingUsage, max: 25 },
                { label: 'Access Controls', value: scores.accessControls, max: 20 },
                { label: 'Compliance Risk', value: scores.complianceRisk, max: 20 },
                { label: 'Vendor Transparency', value: scores.vendorTransparency, max: 10 }
            ];

            scoresGrid.innerHTML = scoreItems.map(item => `
                <div class="score-item">
                    <div class="score-value">${Math.round(item.value)}/${item.max}</div>
                    <div class="score-label">${item.label}</div>
                </div>
            `).join('');
        }

        // Display risk factors
        function displayRiskFactors(factors) {
            const riskFactorsEl = document.getElementById('riskFactors');
            riskFactorsEl.innerHTML = `
                <h3>🔍 Key Risk Factors</h3>
                ${factors.map(factor => `
                    <div class="factor">
                        <div class="factor-label">${factor.label}</div>
                        <div class="factor-detail">${factor.detail}</div>
                    </div>
                `).join('')}
            `;
        }

        // Display sources
        function displaySources(sources) {
            const sourcesList = document.getElementById('sourcesList');
            sourcesList.innerHTML = sources.map(source => `
                <div class="source-item">
                    <div class="source-icon">📄</div>
                    <a href="${source.url}" target="_blank" class="source-url">${source.title}</a>
                </div>
            `).join('');
        }

        // Load database from JSON file (optional - handles CORS issues)
        async function loadDatabaseFromFile() {
            try {
                // Try to load from file, but don't fail if CORS blocks it
                const response = await fetch('ai_tools_database.json');
                if (response.ok) {
                    const database = await response.json();
                    console.log('Loaded database from file:', database);
                    return database;
                } else {
                    console.log('Could not load database file (CORS or file not found)');
                    return null;
                }
            } catch (error) {
                console.log('CORS or network error loading database file:', error.message);
                console.log('This is normal when running from file:// protocol');
                return null;
            }
        }

        // Create new database structure
        function createNewDatabase() {
            return {
                metadata: {
                    version: "1.0",
                    lastUpdated: new Date().toISOString(),
                    totalTools: 0,
                    frameworkVersion: "2.0"
                },
                tools: {},
                assessmentHistory: [],
                exportTemplates: {
                    basic: ["name", "totalScore", "riskLevel"],
                    standard: ["name", "totalScore", "riskLevel", "riskFactors", "usageNote"],
                    pro: ["name", "totalScore", "riskLevel", "riskFactors", "usageNote", "scores", "assessmentDate", "sources"]
                }
            };
        }

        // Import JSON file manually
        function importJSONFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const importedDatabase = JSON.parse(e.target.result);
                            console.log('Imported database:', importedDatabase);
                            
                            // Merge with existing localStorage data
                            const localData = localStorage.getItem('aiToolDatabase');
                            const localDatabase = localData ? JSON.parse(localData) : createNewDatabase();
                            
                            // Merge tools (imported takes precedence)
                            const mergedDatabase = { ...localDatabase };
                            if (importedDatabase.tools) {
                                Object.keys(importedDatabase.tools).forEach(toolId => {
                                    mergedDatabase.tools[toolId] = importedDatabase.tools[toolId];
                                });
                            }
                            
                            // Update metadata
                            mergedDatabase.metadata.totalTools = Object.keys(mergedDatabase.tools).length;
                            mergedDatabase.metadata.lastUpdated = new Date().toISOString();
                            
                            // Save to localStorage
                            localStorage.setItem('aiToolDatabase', JSON.stringify(mergedDatabase));
                            
                            updateDBStatus('✅ JSON File Imported', 'success');
                            showSuccess(`Imported ${Object.keys(importedDatabase.tools || {}).length} tools from JSON file`);
                            
                        } catch (error) {
                            showError('Error reading JSON file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Save database to JSON file (download)
        function saveDatabaseToFile(database) {
            console.log('Creating downloadable database file:', database);
            
            // Create downloadable JSON file
            const dataStr = JSON.stringify(database, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'ai_tools_database.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Sync database (simplified - localStorage only for now)
        async function syncDatabase() {
            updateDBStatus('🔄 Syncing Database...', 'syncing');
            
            try {
                // Load from localStorage
                const localData = localStorage.getItem('aiToolDatabase');
                let database = localData ? JSON.parse(localData) : createNewDatabase();
                
                // Try to load from file (optional - won't fail if CORS blocks it)
                const fileDatabase = await loadDatabaseFromFile();
                if (fileDatabase) {
                    // Merge databases (file takes precedence for existing tools)
                    if (fileDatabase.tools) {
                        Object.keys(fileDatabase.tools).forEach(toolId => {
                            if (!database.tools[toolId]) {
                                // Add tools from file that aren't in localStorage
                                database.tools[toolId] = fileDatabase.tools[toolId];
                            }
                        });
                    }
                }
                
                // Update metadata
                database.metadata.totalTools = Object.keys(database.tools).length;
                database.metadata.lastUpdated = new Date().toISOString();
                
                // Save to localStorage
                localStorage.setItem('aiToolDatabase', JSON.stringify(database));
                
                console.log('Database synced successfully');
                updateDBStatus('✅ Database Synced', 'success');
                return database;
                
            } catch (error) {
                console.error('Error syncing database:', error);
                updateDBStatus('❌ Sync Failed', 'error');
                return null;
            }
        }

        // Update database status indicator
        function updateDBStatus(message, type = 'success') {
            const statusEl = document.getElementById('dbStatus');
            if (statusEl) {
                const colors = {
                    success: '#27ae60',
                    error: '#e74c3c',
                    syncing: '#f39c12'
                };
                statusEl.style.color = colors[type];
                statusEl.innerHTML = message;
                
                // Reset to "Database Ready" after 3 seconds for success/error
                if (type !== 'syncing') {
                    setTimeout(() => {
                        statusEl.style.color = '#27ae60';
                        statusEl.innerHTML = '💾 Database Ready';
                    }, 3000);
                }
            }
        }

        // Save assessment to database
        async function saveToDatabase() {
            if (!currentAssessment || !currentAssessment.results) {
                showError('No assessment results to save');
                return;
            }

            try {
                // Sync database first
                let database = await syncDatabase();
                if (!database) {
                    database = createNewDatabase();
                }

                // Create tool entry
                const toolId = Date.now(); // Simple ID generation
                const toolData = {
                    id: toolId,
                    name: currentAssessment.results.toolName,
                    scores: currentAssessment.results.scores,
                    riskFactors: currentAssessment.results.riskFactors,
                    usageNote: currentAssessment.results.usageNote,
                    assessmentDate: currentAssessment.results.timestamp,
                    lastModified: new Date().toISOString(),
                    aiAssessment: {
                        confidence: currentAssessment.results.confidence,
                        sources: currentAssessment.results.sources,
                        timestamp: currentAssessment.results.timestamp
                    }
                };

                // Add to database
                database.tools[toolId] = toolData;
                database.metadata.totalTools = Object.keys(database.tools).length;
                database.metadata.lastUpdated = new Date().toISOString();

                // Save to localStorage
                localStorage.setItem('aiToolDatabase', JSON.stringify(database));

                showSuccess('Assessment saved to database successfully!');
                
                // Optionally offer to download JSON file
                if (confirm('Assessment saved! Would you like to download the updated database as a JSON file for backup?')) {
                    saveDatabaseToFile(database);
                }
                
            } catch (error) {
                showError('Failed to save assessment: ' + error.message);
            }
        }

        // Export assessment
        function exportAssessment() {
            if (!currentAssessment || !currentAssessment.results) {
                showError('No assessment results to export');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                assessment: currentAssessment.results,
                framework: {
                    version: "2.0",
                    description: "AI Tool Risk Assessment Framework"
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-assessment-${currentAssessment.results.toolName.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showSuccess('Assessment exported successfully!');
        }

        // Start new assessment
        function startNewAssessment() {
            document.getElementById('assessmentForm').reset();
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').textContent = '🤖 Start AI Assessment';
            
            currentAssessment = null;
            isProcessing = false;
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(errorDiv, content.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(successDiv, content.firstChild);
            
            setTimeout(() => successDiv.remove(), 5000);
        }

        // Reset form
        function resetForm() {
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').textContent = '🤖 Start AI Assessment';
            document.getElementById('progressSection').style.display = 'none';
            isProcessing = false;
        }

        // API Configuration Functions
        function toggleAPIConfig() {
            const panel = document.getElementById('apiConfigPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                loadAPIConfig();
            }
        }

        function updateAPIConfig() {
            const provider = document.getElementById('apiProvider').value;
            const modelSelect = document.getElementById('apiModel');
            const baseURLInput = document.getElementById('baseURL');
            
                         // Update model options based on provider
            if (provider === 'cursor') {
                modelSelect.innerHTML = `
                    <option value="cursor-gpt-4">Cursor GPT-4</option>
                    <option value="cursor-claude">Cursor Claude</option>
                `;
                baseURLInput.value = 'cursor://api/v1';
                document.getElementById('apiKey').style.display = 'none';
                document.getElementById('apiKey').previousElementSibling.style.display = 'none';
            } else {
                document.getElementById('apiKey').style.display = 'block';
                document.getElementById('apiKey').previousElementSibling.style.display = 'block';
                
                if (provider === 'openai') {
                    modelSelect.innerHTML = `
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    `;
                    baseURLInput.value = 'https://api.openai.com/v1';
                } else if (provider === 'anthropic') {
                    modelSelect.innerHTML = `
                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                    `;
                    baseURLInput.value = 'https://api.anthropic.com/v1';
                } else if (provider === 'local') {
                    modelSelect.innerHTML = `
                        <option value="local-model">Local Model</option>
                    `;
                    baseURLInput.value = 'http://localhost:1234/v1';
                }
            }
        }

        function saveAPIConfig() {
            const config = {
                provider: document.getElementById('apiProvider').value,
                apiKey: document.getElementById('apiKey').value,
                model: document.getElementById('apiModel').value,
                baseURL: document.getElementById('baseURL').value
            };
            
            // Update global config
            AI_CONFIG.provider = config.provider;
            AI_CONFIG.apiKey = config.apiKey;
            AI_CONFIG.model = config.model;
            AI_CONFIG.baseURL = config.baseURL;
            
            // Save to localStorage (excluding API key for security)
            const safeConfig = { ...config };
            delete safeConfig.apiKey;
            localStorage.setItem('aiAPIConfig', JSON.stringify(safeConfig));
            
            showSuccess('API configuration saved successfully!');
        }

        function loadAPIConfig() {
            try {
                const saved = localStorage.getItem('aiAPIConfig');
                if (saved) {
                    const config = JSON.parse(saved);
                    document.getElementById('apiProvider').value = config.provider || 'openai';
                    document.getElementById('apiModel').value = config.model || 'gpt-4';
                    document.getElementById('baseURL').value = config.baseURL || 'https://api.openai.com/v1';
                    
                    // Update global config
                    AI_CONFIG.provider = config.provider;
                    AI_CONFIG.model = config.model;
                    AI_CONFIG.baseURL = config.baseURL;
                    
                    updateAPIConfig();
                }
            } catch (e) {
                console.warn('Could not load API config:', e);
            }
        }

        async function testAPIConnection() {
            try {
                const apiKey = document.getElementById('apiKey').value;
                const provider = document.getElementById('apiProvider').value;
                const baseURL = document.getElementById('baseURL').value;
                const model = document.getElementById('apiModel').value;

                if (!apiKey) {
                    showError('Please enter an API key first');
                    return;
                }

                showSuccess('Testing API connection...');

                let testPayload, testHeaders;
                
                if (provider === 'openai') {
                    testPayload = {
                        model: model,
                        messages: [{ role: 'user', content: 'Test connection' }],
                        max_tokens: 10
                    };
                    testHeaders = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                } else if (provider === 'anthropic') {
                    testPayload = {
                        model: model,
                        messages: [{ role: 'user', content: 'Test connection' }],
                        max_tokens: 10
                    };
                    testHeaders = {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                }

                const response = await fetch(`${baseURL}/chat/completions`, {
                    method: 'POST',
                    headers: testHeaders,
                    body: JSON.stringify(testPayload)
                });

                if (response.ok) {
                    showSuccess('✅ API connection successful!');
                } else {
                    showError(`❌ API connection failed: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                showError(`❌ Connection test failed: ${error.message}`);
            }
        }

        // Chat Interface Functions
        function toggleChatInterface() {
            const chatInterface = document.getElementById('chatInterface');
            chatInterface.style.display = chatInterface.style.display === 'none' ? 'block' : 'none';
            
            // Focus on chat input when opening
            if (chatInterface.style.display === 'block') {
                document.getElementById('chatInput').focus();
            }
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addChatMessage('user', message);
            chatInput.value = '';
            
            // Show typing indicator
            const typingId = addChatMessage('bot', '🤖 Thinking...');
            
            try {
                // Load API config
                loadAPIConfig();
                const apiKey = AI_CONFIG.apiKey || document.getElementById('apiKey')?.value;
                
                if (!apiKey) {
                    updateChatMessage(typingId, '❌ Please configure your API key first in the API Configuration panel.');
                    return;
                }
                
                // Send to AI
                const response = await getChatResponse(message, apiKey);
                updateChatMessage(typingId, response);
                
            } catch (error) {
                updateChatMessage(typingId, `❌ Error: ${error.message}`);
            }
        }

        async function getChatResponse(message, apiKey) {
            const prompt = `You are an AI risk assessment expert. The user is asking about AI tool security and compliance risks. 

User question: ${message}

Provide a helpful, accurate response about AI tool risks, security considerations, compliance issues, or generate risk assessments as requested. Keep responses practical and enterprise-focused.`;

            const response = await fetch(`${AI_CONFIG.baseURL}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: AI_CONFIG.model,
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert AI risk assessment consultant specializing in enterprise security and compliance. Provide practical, actionable advice about AI tool risks.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function addChatMessage(type, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${type}-message`;
            messageDiv.style.marginBottom = '10px';
            messageDiv.style.padding = '10px';
            messageDiv.style.borderRadius = '6px';
            messageDiv.style.backgroundColor = type === 'user' ? '#e3f2fd' : '#f5f5f5';
            
            const prefix = type === 'user' ? '👤 You:' : '🤖 AI Assistant:';
            messageDiv.innerHTML = `<strong>${prefix}</strong> ${content}`;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageId;
        }

        function updateChatMessage(messageId, newContent) {
            const messageEl = document.getElementById(messageId);
            if (messageEl) {
                messageEl.innerHTML = `<strong>🤖 AI Assistant:</strong> ${newContent}`;
            }
        }

        // Initialize chat input enter key handler
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });
    </script>
</body>
</html> 