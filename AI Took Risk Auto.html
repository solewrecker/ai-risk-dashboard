<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic AI Tool Risk Assessment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .add-tool-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        }

        .add-tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .export-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .search-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }

        .search-input {
            padding: 8px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: 200px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }

        .content {
            padding: 40px;
        }

        .executive-summary {
            background: #ecf0f1;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 40px;
            border-left: 5px solid #3498db;
        }

        .key-findings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .finding-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ecf0f1;
            text-align: center;
        }

        .finding-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .critical { color: #e74c3c; }
        .high { color: #f39c12; }
        .medium { color: #f1c40f; }
        .low { color: #27ae60; }

        .risk-section {
            margin: 40px 0;
        }

        .risk-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.3rem;
        }

        .critical-header { background: #fdf2ef; color: #c0392b; border-left: 5px solid #e74c3c; }
        .high-header { background: #fef9e7; color: #d68910; border-left: 5px solid #f39c12; }
        .medium-header { background: #fefbea; color: #b7950b; border-left: 5px solid #f1c40f; }
        .low-header { background: #eafaf1; color: #196f3d; border-left: 5px solid #27ae60; }

        .tool-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            transition: all 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tool-name {
            font-size: 1.4rem;
            font-weight: bold;
        }

        .tool-actions {
            display: flex;
            gap: 10px;
        }

        .edit-btn, .delete-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .edit-btn:hover {
            background: #2980b9;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .info-icon {
            cursor: pointer;
            margin-left: 5px;
            padding: 2px 4px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 12px;
        }

        .info-icon:hover {
            background: #2980b9;
        }

        .category-breakdown {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
        }

        .subcategory-item {
            margin-bottom: 8px;
            padding: 6px;
            background: white;
            border-radius: 3px;
            border-left: 3px solid #3498db;
        }

        .subcategory-item h5 {
            margin: 0 0 4px 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .guidance-list {
            margin: 0;
            padding-left: 15px;
        }

        .guidance-list li {
            margin-bottom: 2px;
            font-size: 11px;
        }

        .risk-score {
            font-size: 1.8rem;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            margin-left: 10px;
        }

        .critical-score { background: #e74c3c; }
        .high-score { background: #f39c12; }
        .medium-score { background: #f1c40f; color: #2c3e50; }
        .low-score { background: #27ae60; }

        .risk-factors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .factor {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        .factor-label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .factor-detail {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .usage-note {
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .usage-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .usage-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .usage-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .usage-info {
            background: #e6bd7f;
            border: 1px solid #ffeaa7;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .save-btn, .cancel-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-right: 10px;
            transition: all 0.2s ease;
        }

        .save-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
        }

        .cancel-btn {
            background: #95a5a6;
            color: white;
        }

        .cancel-btn:hover {
            background: #7f8c8d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-filter {
                margin-left: 0;
                justify-content: stretch;
            }

            .search-input {
                min-width: auto;
                flex: 1;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dynamic AI Tool Risk Assessment</h1>
            <p class="subtitle">Enterprise Security & Compliance Analysis Dashboard</p>
        </div>

        <div class="controls">
            <button class="add-tool-btn" onclick="openAddModal()">
                ➕ Add New Tool
            </button>
            <button class="export-btn" onclick="exportData()">
                📊 Export Data
            </button>
            <button class="export-btn" onclick="showDatabaseStats()" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                📈 Database Stats
            </button>
            <button class="export-btn" onclick="refreshDatabase()" style="background: linear-gradient(135deg, #e67e22, #d35400);">
                🔄 Refresh Database
            </button>
            <button class="export-btn" onclick="debugDatabase()" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d);">
                🐛 Debug DB
            </button>
            <div class="search-filter">
                <input type="text" class="search-input" id="searchInput" placeholder="🔍 Search tools..." oninput="filterTools()">
                <select class="filter-select" id="riskFilter" onchange="filterTools()">
                    <option value="all">All Risk Levels</option>
                    <option value="critical">Critical Risk</option>
                    <option value="high">High Risk</option>
                    <option value="medium">Medium Risk</option>
                    <option value="low">Low Risk</option>
                </select>
            </div>
            <div id="dbStatus" style="margin-left: 15px; font-size: 0.9rem; color: #27ae60; font-weight: 500;">
                💾 Database Ready
            </div>
        </div>

        <div class="content">
            <div class="executive-summary">
                <h2>Executive Summary</h2>
                <p>Our comprehensive risk assessment evaluates AI tools across multiple security, compliance, and governance dimensions. The analysis reveals significant variations in risk profiles, with several tools presenting critical compliance gaps that require immediate attention.</p>
                
                <div class="key-findings" id="keyFindings">
                    <!-- Auto-generated stats -->
                </div>
            </div>

            <div id="toolSections">
                <!-- Auto-generated tool sections -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Tool Modal -->
    <div id="toolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New Tool</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <form id="toolForm" onsubmit="saveTool(event)">
                <div class="form-group">
                    <label class="form-label">Tool Name *</label>
                    <input type="text" class="form-input" id="toolName" required>
                </div>

                <!-- Scoring Reference Panel -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0; color: #2c3e50;">📊 Scoring Guidance</h3>
                        <button type="button" id="toggleGuidance" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Show Details</button>
                    </div>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">Higher scores = Higher risk. Click "Show Details" for comprehensive scoring criteria.</p>
                    <div id="scoringGuidancePanel" style="display: none; margin-top: 15px;">
                        <!-- Detailed guidance will be populated here -->
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            Data Storage & Security (0-25)
                            <span class="info-icon" onclick="showCategoryHelp('dataStorage')" title="Click for detailed scoring guidance">ℹ️</span>
                        </label>
                        <input type="number" class="form-input" id="dataStorage" min="0" max="25" value="0">
                        <div class="category-breakdown" id="dataStorage-breakdown" style="display: none; margin-top: 8px; font-size: 12px; color: #666;">
                            <!-- Subcategory breakdown will appear here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            Training Data Usage (0-25)
                            <span class="info-icon" onclick="showCategoryHelp('trainingUsage')" title="Click for detailed scoring guidance">ℹ️</span>
                        </label>
                        <input type="number" class="form-input" id="trainingUsage" min="0" max="25" value="0">
                        <div class="category-breakdown" id="trainingUsage-breakdown" style="display: none; margin-top: 8px; font-size: 12px; color: #666;">
                            <!-- Subcategory breakdown will appear here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            Access Controls (0-20)
                            <span class="info-icon" onclick="showCategoryHelp('accessControls')" title="Click for detailed scoring guidance">ℹ️</span>
                        </label>
                        <input type="number" class="form-input" id="accessControls" min="0" max="20" value="0">
                        <div class="category-breakdown" id="accessControls-breakdown" style="display: none; margin-top: 8px; font-size: 12px; color: #666;">
                            <!-- Subcategory breakdown will appear here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            Compliance Risk (0-20)
                            <span class="info-icon" onclick="showCategoryHelp('complianceRisk')" title="Click for detailed scoring guidance">ℹ️</span>
                        </label>
                        <input type="number" class="form-input" id="complianceRisk" min="0" max="20" value="0">
                        <div class="category-breakdown" id="complianceRisk-breakdown" style="display: none; margin-top: 8px; font-size: 12px; color: #666;">
                            <!-- Subcategory breakdown will appear here -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            Vendor Transparency (0-10)
                            <span class="info-icon" onclick="showCategoryHelp('vendorTransparency')" title="Click for detailed scoring guidance">ℹ️</span>
                        </label>
                        <input type="number" class="form-input" id="vendorTransparency" min="0" max="10" value="0">
                        <div class="category-breakdown" id="vendorTransparency-breakdown" style="display: none; margin-top: 8px; font-size: 12px; color: #666;">
                            <!-- Subcategory breakdown will appear here -->
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Key Risk Factors (JSON format)</label>
                    <textarea class="form-textarea" id="riskFactors" placeholder='[{"label": "Factor Name", "detail": "Factor description"}]'></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Usage Notes</label>
                    <div class="form-grid">
                        <select class="form-select" id="usageNoteType">
                            <option value="">No usage note</option>
                            <option value="warning">Warning</option>
                            <option value="danger">Danger</option>
                            <option value="success">Success</option>
                            <option value="info">Info</option>
                        </select>
                        <input type="text" class="form-input" id="usageNoteTitle" placeholder="Usage note title">
                    </div>
                    <textarea class="form-textarea" id="usageNoteContent" placeholder="Usage note content"></textarea>
                </div>

                <div style="margin-top: 30px;">
                    <button type="submit" class="save-btn">💾 Save Tool</button>
                    <button type="button" class="cancel-btn" onclick="closeModal()">❌ Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Enhanced scoring criteria with detailed guidance
        const scoringCriteria = {
            dataStorage: { 
                max: 25, 
                label: "Data Storage & Security",
                subcategories: {
                    geographic: {
                        label: "Geographic Control (0-8 points)",
                        guidance: [
                            "0: On-premises or controlled data residency",
                            "3: Known secure regions (US, EU) with contracts", 
                            "6: External servers, unclear location",
                            "8: Servers in jurisdictions with poor data laws"
                        ]
                    },
                    encryption: {
                        label: "Encryption Standards (0-7 points)",
                        guidance: [
                            "0: End-to-end encryption with customer key control",
                            "2: Encryption at rest and in transit (vendor keys)",
                            "4: Encryption in transit only", 
                            "7: No encryption or unclear encryption"
                        ]
                    },
                    retention: {
                        label: "Data Retention (0-10 points)",
                        guidance: [
                            "0: No retention or customer-controlled deletion",
                            "3: Clear, limited retention policies",
                            "6: Long retention periods (>1 year)",
                            "10: Indefinite retention or unclear policies"
                        ]
                    }
                }
            },
            trainingUsage: { 
                max: 25, 
                label: "Training Data Usage",
                subcategories: {
                    training: {
                        label: "Model Training (0-20 points)", 
                        guidance: [
                            "0: Contractual guarantee of no training use",
                            "5: Opt-out available with clear process",
                            "15: Default training use with difficult opt-out",
                            "20: Always used for training, no opt-out"
                        ]
                    },
                    sharing: {
                        label: "Data Sharing (0-5 points)",
                        guidance: [
                            "0: No third-party sharing",
                            "3: Limited sharing with clear disclosure", 
                            "5: Broad sharing or unclear sharing practices"
                        ]
                    }
                }
            },
            accessControls: { 
                max: 20, 
                label: "Access Controls",
                subcategories: {
                    admin: {
                        label: "Admin Management (0-8 points)",
                        guidance: [
                            "0: Full enterprise admin controls",
                            "3: Basic user management",
                            "6: Limited controls",
                            "8: No admin oversight"
                        ]
                    },
                    audit: {
                        label: "Audit Capabilities (0-7 points)",
                        guidance: [
                            "0: Comprehensive audit logs and monitoring",
                            "3: Basic usage tracking",
                            "7: No audit capabilities"
                        ]
                    },
                    integration: {
                        label: "Integration (0-5 points)",
                        guidance: [
                            "0: Full SSO and enterprise integration",
                            "2: Basic SSO support",
                            "5: No enterprise integration"
                        ]
                    }
                }
            },
            complianceRisk: { 
                max: 20, 
                label: "Compliance & Legal Risk",
                subcategories: {
                    violations: {
                        label: "Regulatory Violations (0-15 points)",
                        guidance: [
                            "0: Compliant with major regulations (GDPR, HIPAA, SOX)",
                            "5: Some compliance gaps, manageable risk",
                            "10: Moderate violation risk",
                            "15: High probability of regulatory violations"
                        ]
                    },
                    transparency: {
                        label: "Data Processing Transparency (0-5 points)",
                        guidance: [
                            "0: Clear documentation of all data processing",
                            "2: Some processing transparency",
                            "5: Opaque or unclear data processing"
                        ]
                    }
                }
            },
            vendorTransparency: { 
                max: 10, 
                label: "Vendor Transparency",
                subcategories: {
                    overall: {
                        label: "Overall Transparency (0-10 points)",
                        guidance: [
                            "0: Excellent documentation, clear policies, responsive support",
                            "3: Good documentation with some gaps",
                            "6: Limited transparency, unclear practices", 
                            "10: Poor or no transparency, unresponsive vendor"
                        ]
                    }
                }
            }
        };

        // Tool data storage
        let tools = [
            {
                id: 1,
                name: "ChatGPT Free",
                scores: {
                    dataStorage: 20,
                    trainingUsage: 25,
                    accessControls: 20,
                    complianceRisk: 15,
                    vendorTransparency: 2
                },
                riskFactors: [
                    {"label": "Training Data Usage", "detail": "All conversations used for model training by default"},
                    {"label": "Compliance Gaps", "detail": "Not HIPAA compliant, no Business Associate Agreement available"},
                    {"label": "Data Retention", "detail": "Indefinite retention policy with limited user control"},
                    {"label": "Access Controls", "detail": "No enterprise admin oversight or audit capabilities"}
                ],
                usageNote: {
                    type: "warning",
                    title: "⚠️ If Use Required:",
                    content: "Never input confidential data, customer information, or regulated content. Consider as public forum. Manually delete conversations immediately after use."
                }
            },
            {
                id: 2,
                name: "123 Notetaker AI",
                scores: {
                    dataStorage: 17,
                    trainingUsage: 25,
                    accessControls: 20,
                    complianceRisk: 20,
                    vendorTransparency: 5
                },
                riskFactors: [
                    {"label": "Compliance Violations", "detail": "Not compliant with HIPAA, SOC 2, ISO 27001, or any major regulatory framework"},
                    {"label": "Training Data Usage", "detail": "No contractual guarantee against training use of meeting audio/video"},
                    {"label": "Data Retention", "detail": "Unclear retention periods during active use"},
                    {"label": "Enterprise Controls", "detail": "No organizational oversight or audit capabilities"}
                ],
                usageNote: {
                    type: "danger",
                    title: "🚫 Immediate Removal Required:",
                    content: "Uninstall from all devices. Existing recordings may already be compromised. No safe usage scenario exists."
                }
            },
            {
                id: 3,
                name: "Claude Enterprise",
                scores: {
                    dataStorage: 5,
                    trainingUsage: 0,
                    accessControls: 8,
                    complianceRisk: 9,
                    vendorTransparency: 0
                },
                riskFactors: [
                    {"label": "Strong Security", "detail": "Zero data retention option with no training use"},
                    {"label": "Enterprise Controls", "detail": "Comprehensive admin controls and audit capabilities"},
                    {"label": "HIPAA Limitation", "detail": "Standard plans not covered by HIPAA BAA"}
                ],
                usageNote: {
                    type: "success",
                    title: "🏅 Top Choice:",
                    content: "Excellent privacy controls and enterprise features. Custom retention settings available. Ideal for sensitive business use."
                }
            },
            {
                id: 4,
                name: "Microsoft Copilot (M365) Enterprise",
                scores: {
                    dataStorage: 5,
                    trainingUsage: 0,
                    accessControls: 2,
                    complianceRisk: 8,
                    vendorTransparency: 0
                },
                riskFactors: [
                    {"label": "Strong Integration", "detail": "Native M365 integration with comprehensive admin controls"},
                    {"label": "HIPAA Limitation", "detail": "Web search functionality excluded from HIPAA coverage"}
                ],
                usageNote: {
                    type: "success",
                    title: "🏢 Recommended:",
                    content: "Excellent for M365 environments. Disable web search for HIPAA compliance. Comprehensive admin controls available."
                }
            }
        ];

        let editingId = null;

        // Calculate total score for a tool
        function calculateScore(scores) {
            return scores.dataStorage + scores.trainingUsage + scores.accessControls + scores.complianceRisk + scores.vendorTransparency;
        }

        // Get risk level based on score
        function getRiskLevel(score) {
            if (score >= 80) return 'critical';
            if (score >= 60) return 'high';
            if (score >= 35) return 'medium';
            return 'low';
        }

        // Get risk level display info
        function getRiskInfo(level) {
            const info = {
                critical: { 
                    name: '🔴 CRITICAL RISK - Immediate Action Required', 
                    class: 'critical-header',
                    scoreClass: 'critical-score'
                },
                high: { 
                    name: '🟠 HIGH RISK - Significant Controls Needed', 
                    class: 'high-header',
                    scoreClass: 'high-score'
                },
                medium: { 
                    name: '🟡 MEDIUM RISK - Standard Enterprise Controls Required', 
                    class: 'medium-header',
                    scoreClass: 'medium-score'
                },
                low: { 
                    name: '🟢 LOW RISK - Basic Monitoring Sufficient', 
                    class: 'low-header',
                    scoreClass: 'low-score'
                }
            };
            return info[level];
        }

        // Render executive summary
        function renderExecutiveSummary() {
            const stats = { critical: 0, high: 0, medium: 0, low: 0 };
            
            tools.forEach(tool => {
                const score = calculateScore(tool.scores);
                const level = getRiskLevel(score);
                stats[level]++;
            });

            const findingsHTML = `
                <div class="finding-card">
                    <div class="finding-number critical">${stats.critical}</div>
                    <div>Critical Risk Tools</div>
                    <small>Require immediate blocking</small>
                </div>
                <div class="finding-card">
                    <div class="finding-number high">${stats.high}</div>
                    <div>High Risk Tools</div>
                    <small>Need significant controls</small>
                </div>
                <div class="finding-card">
                    <div class="finding-number medium">${stats.medium}</div>
                    <div>Medium Risk Tools</div>
                    <small>Standard controls required</small>
                </div>
                <div class="finding-card">
                    <div class="finding-number low">${stats.low}</div>
                    <div>Low Risk Tools</div>
                    <small>Basic monitoring sufficient</small>
                </div>
            `;

            document.getElementById('keyFindings').innerHTML = findingsHTML;
        }

        // Render tool card
        function renderToolCard(tool) {
            const score = calculateScore(tool.scores);
            const level = getRiskLevel(score);
            const riskInfo = getRiskInfo(level);

            const factorsHTML = tool.riskFactors.map(factor => `
                <div class="factor">
                    <div class="factor-label">${factor.label}</div>
                    <div class="factor-detail">${factor.detail}</div>
                </div>
            `).join('');

            const usageNoteHTML = tool.usageNote ? `
                <div class="usage-note usage-${tool.usageNote.type}">
                    <strong>${tool.usageNote.title}</strong> ${tool.usageNote.content}
                </div>
            ` : '';

            return `
                <div class="tool-card" data-tool-id="${tool.id}" data-risk-level="${level}">
                    <div class="tool-header">
                        <div class="tool-name">${tool.name}</div>
                        <div style="display: flex; align-items: center;">
                            <div class="tool-actions">
                                <button class="edit-btn" onclick="editTool(${tool.id})">✏️ Edit</button>
                                <button class="delete-btn" onclick="deleteTool(${tool.id})">🗑️ Delete</button>
                            </div>
                            <div class="risk-score ${riskInfo.scoreClass}">${score}</div>
                        </div>
                    </div>
                    <div class="risk-factors">
                        ${factorsHTML}
                    </div>
                    ${usageNoteHTML}
                </div>
            `;
        }

        // Render all tools
        function renderTools() {
            // Group tools by risk level and sort by score (descending)
            const toolsByRisk = { critical: [], high: [], medium: [], low: [] };
            
            tools.forEach(tool => {
                const score = calculateScore(tool.scores);
                const level = getRiskLevel(score);
                toolsByRisk[level].push({...tool, totalScore: score});
            });

            // Sort each group by score (highest first)
            Object.keys(toolsByRisk).forEach(level => {
                toolsByRisk[level].sort((a, b) => b.totalScore - a.totalScore);
            });

            let sectionsHTML = '';

            // Render each risk level section
            ['critical', 'high', 'medium', 'low'].forEach(level => {
                if (toolsByRisk[level].length > 0) {
                    const riskInfo = getRiskInfo(level);
                    const toolsHTML = toolsByRisk[level].map(tool => renderToolCard(tool)).join('');
                    
                    sectionsHTML += `
                        <div class="risk-section" data-risk-level="${level}">
                            <div class="risk-header ${riskInfo.class}">
                                ${riskInfo.name}
                            </div>
                            ${toolsHTML}
                        </div>
                    `;
                }
            });

            if (sectionsHTML === '') {
                sectionsHTML = `
                    <div class="empty-state">
                        <h3>No tools added yet</h3>
                        <p>Click "Add New Tool" to get started with your risk assessment.</p>
                    </div>
                `;
            }

            document.getElementById('toolSections').innerHTML = sectionsHTML;
            renderExecutiveSummary();
        }

        // Filter tools based on search and risk level
        function filterTools() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const riskFilter = document.getElementById('riskFilter').value;

            const toolCards = document.querySelectorAll('.tool-card');
            const riskSections = document.querySelectorAll('.risk-section');

            // Hide all sections first
            riskSections.forEach(section => {
                section.style.display = 'none';
            });

            let visibleCount = 0;

            toolCards.forEach(card => {
                const toolName = card.querySelector('.tool-name').textContent.toLowerCase();
                const riskLevel = card.dataset.riskLevel;
                
                const matchesSearch = toolName.includes(searchTerm);
                const matchesFilter = riskFilter === 'all' || riskLevel === riskFilter;
                
                if (matchesSearch && matchesFilter) {
                    card.style.display = 'block';
                    // Show parent section
                    card.closest('.risk-section').style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Hide sections with no visible cards
            riskSections.forEach(section => {
                const visibleCards = section.querySelectorAll('.tool-card[style*="block"]').length;
                if (visibleCards === 0) {
                    section.style.display = 'none';
                }
            });
        }

        // Open add modal
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add New Tool';
            document.getElementById('toolForm').reset();
            document.getElementById('toolModal').style.display = 'block';
        }

        // Edit tool
        function editTool(id) {
            const tool = tools.find(t => t.id === id);
            if (!tool) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'Edit Tool';
            
            // Populate form with existing data
            document.getElementById('toolName').value = tool.name;
            document.getElementById('dataStorage').value = tool.scores.dataStorage;
            document.getElementById('trainingUsage').value = tool.scores.trainingUsage;
            document.getElementById('accessControls').value = tool.scores.accessControls;
            document.getElementById('complianceRisk').value = tool.scores.complianceRisk;
            document.getElementById('vendorTransparency').value = tool.scores.vendorTransparency;
            document.getElementById('riskFactors').value = JSON.stringify(tool.riskFactors, null, 2);
            
            if (tool.usageNote) {
                document.getElementById('usageNoteType').value = tool.usageNote.type;
                document.getElementById('usageNoteTitle').value = tool.usageNote.title;
                document.getElementById('usageNoteContent').value = tool.usageNote.content;
            }
            
            document.getElementById('toolModal').style.display = 'block';
        }

        // Delete tool
        function deleteTool(id) {
            if (confirm('Are you sure you want to delete this tool? This action cannot be undone.')) {
                tools = tools.filter(t => t.id !== id);
                renderTools();
                saveToDatabase(); // Save to JSON database instead of localStorage
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('toolModal').style.display = 'none';
            document.getElementById('toolForm').reset();
            editingId = null;
        }

        // Save tool
        function saveTool(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('toolName').value,
                scores: {
                    dataStorage: parseInt(document.getElementById('dataStorage').value) || 0,
                    trainingUsage: parseInt(document.getElementById('trainingUsage').value) || 0,
                    accessControls: parseInt(document.getElementById('accessControls').value) || 0,
                    complianceRisk: parseInt(document.getElementById('complianceRisk').value) || 0,
                    vendorTransparency: parseInt(document.getElementById('vendorTransparency').value) || 0
                }
            };

            // Parse risk factors
            try {
                const riskFactorsText = document.getElementById('riskFactors').value.trim();
                formData.riskFactors = riskFactorsText ? JSON.parse(riskFactorsText) : [];
            } catch (e) {
                alert('Invalid JSON format in Risk Factors. Please check your syntax.');
                return;
            }

            // Usage note
            const usageNoteType = document.getElementById('usageNoteType').value;
            if (usageNoteType) {
                formData.usageNote = {
                    type: usageNoteType,
                    title: document.getElementById('usageNoteTitle').value || '',
                    content: document.getElementById('usageNoteContent').value || ''
                };
            }

            if (editingId) {
                // Update existing tool
                const toolIndex = tools.findIndex(t => t.id === editingId);
                if (toolIndex !== -1) {
                    // Add version tracking before updating
                    addVersionToTool(tools[toolIndex]);
                    tools[toolIndex] = { ...tools[toolIndex], ...formData };
                }
            } else {
                // Add new tool
                const newId = Math.max(...tools.map(t => t.id), 0) + 1;
                const newTool = { id: newId, ...formData };
                tools.push(newTool);
            }

            renderTools();
            closeModal();
            saveToDatabase(); // Save to JSON database instead of localStorage
        }

        // Export data
        function exportData() {
            showExportOptions();
        }

        // Enhanced export with levels
        function exportDataWithLevel(level = 'standard') {
            const exportData = {
                exportDate: new Date().toISOString(),
                exportLevel: level,
                framework: {
                    version: "2.0",
                    description: "AI Tool Risk Assessment Framework"
                },
                summary: generateSummaryStats(),
                tools: []
            };

            const templates = {
                basic: ['name', 'totalScore', 'riskLevel'],
                standard: ['name', 'totalScore', 'riskLevel', 'riskFactors', 'usageNote'],
                pro: ['name', 'totalScore', 'riskLevel', 'riskFactors', 'usageNote', 'scores', 'assessmentDate', 'sources']
            };

            tools.forEach(tool => {
                const toolData = {};
                const score = calculateScore(tool.scores);
                const riskLevel = getRiskLevel(score);
                
                templates[level].forEach(field => {
                    switch(field) {
                        case 'name':
                            toolData.name = tool.name;
                            break;
                        case 'totalScore':
                            toolData.totalScore = score;
                            break;
                        case 'riskLevel':
                            toolData.riskLevel = riskLevel.toUpperCase();
                            break;
                        case 'riskFactors':
                            toolData.riskFactors = tool.riskFactors;
                            break;
                        case 'usageNote':
                            toolData.usageNote = tool.usageNote;
                            break;
                        case 'scores':
                            toolData.scores = tool.scores;
                            break;
                        case 'assessmentDate':
                            toolData.assessmentDate = tool.assessmentDate || new Date().toISOString();
                            break;
                        case 'sources':
                            toolData.sources = tool.sources || [];
                            break;
                    }
                });
                
                exportData.tools.push(toolData);
            });

            return exportData;
        }

        // Export full database
        function exportFullDatabase() {
            const database = {
                metadata: {
                    version: "1.0",
                    lastUpdated: new Date().toISOString(),
                    totalTools: tools.length,
                    frameworkVersion: "2.0"
                },
                tools: {},
                assessmentHistory: []
            };
            
            tools.forEach(tool => {
                database.tools[tool.id] = {
                    ...tool,
                    assessmentDate: tool.assessmentDate || new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
            });
            
            const dataStr = JSON.stringify(database, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-tool-database-full-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Export selection modal
        function showExportOptions() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>Export Options</h2>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div style="padding: 20px;">
                        <h3>Select Export Level:</h3>
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin: 10px 0;">
                                <input type="radio" name="exportLevel" value="basic" checked> 
                                <strong>Basic</strong> - Tool name, score, risk level only
                            </label>
                            <label style="display: block; margin: 10px 0;">
                                <input type="radio" name="exportLevel" value="standard"> 
                                <strong>Standard</strong> - Basic + risk factors + usage notes
                            </label>
                            <label style="display: block; margin: 10px 0;">
                                <input type="radio" name="exportLevel" value="pro"> 
                                <strong>Pro</strong> - Everything + detailed breakdowns
                            </label>
                            <label style="display: block; margin: 10px 0;">
                                <input type="radio" name="exportLevel" value="database"> 
                                <strong>Full Database</strong> - Complete database with metadata and versions
                            </label>
                        </div>
                        <div style="margin: 20px 0;">
                            <label style="display: block; margin: 10px 0;">
                                <input type="checkbox" id="includeCSV" checked> Include CSV export
                            </label>
                            <label style="display: block; margin: 10px 0;">
                                <input type="checkbox" id="includeJSON" checked> Include JSON export
                            </label>
                        </div>
                        <div style="text-align: center; margin-top: 30px;">
                            <button onclick="executeExport()" class="save-btn">Export</button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="cancel-btn">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function executeExport() {
            const level = document.querySelector('input[name="exportLevel"]:checked').value;
            const includeCSV = document.getElementById('includeCSV').checked;
            const includeJSON = document.getElementById('includeJSON').checked;
            
            if (level === 'database') {
                // Export full database
                exportFullDatabase();
            } else {
                const exportData = exportDataWithLevel(level);
                
                if (includeJSON) {
                    downloadJSON(exportData, level);
                }
                
                if (includeCSV) {
                    downloadCSV(exportData, level);
                }
            }
            
            // Close modal
            document.querySelector('.modal').remove();
        }

        function downloadJSON(data, level) {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-tool-risk-assessment-${level}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function downloadCSV(data, level) {
            const headers = ['Tool Name', 'Total Score', 'Risk Level'];
            
            if (level === 'standard' || level === 'pro') {
                headers.push('Risk Factors', 'Usage Note Type', 'Usage Note Title');
            }
            
            if (level === 'pro') {
                headers.push('Data Storage Score', 'Training Usage Score', 'Access Controls Score', 'Compliance Risk Score', 'Vendor Transparency Score');
            }
            
            const csvData = data.tools.map(tool => {
                const row = [
                    `"${tool.name}"`,
                    tool.totalScore,
                    tool.riskLevel
                ];
                
                if (level === 'standard' || level === 'pro') {
                    row.push(
                        `"${tool.riskFactors ? tool.riskFactors.map(f => f.label).join('; ') : ''}"`,
                        tool.usageNote ? tool.usageNote.type : '',
                        `"${tool.usageNote ? tool.usageNote.title : ''}"`
                    );
                }
                
                if (level === 'pro') {
                    row.push(
                        tool.scores.dataStorage,
                        tool.scores.trainingUsage,
                        tool.scores.accessControls,
                        tool.scores.complianceRisk,
                        tool.scores.vendorTransparency
                    );
                }
                
                return row.join(',');
            });
            
            const csvContent = [headers.join(','), ...csvData].join('\n');
            const csvBlob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(csvBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-tool-risk-assessment-${level}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Export as CSV (keeping original function for backward compatibility)
        function exportCSV() {
            const headers = [
                'Tool Name',
                'Total Score',
                'Risk Level',
                'Data Storage Score',
                'Training Usage Score',
                'Access Controls Score',
                'Compliance Risk Score',
                'Vendor Transparency Score',
                'Usage Note Type',
                'Usage Note Title'
            ];

            const csvData = tools.map(tool => {
                const totalScore = calculateScore(tool.scores);
                const riskLevel = getRiskLevel(totalScore);
                
                return [
                    `"${tool.name}"`,
                    totalScore,
                    riskLevel.toUpperCase(),
                    tool.scores.dataStorage,
                    tool.scores.trainingUsage,
                    tool.scores.accessControls,
                    tool.scores.complianceRisk,
                    tool.scores.vendorTransparency,
                    tool.usageNote ? tool.usageNote.type : '',
                    tool.usageNote ? `"${tool.usageNote.title}"` : ''
                ].join(',');
            });

            const csvContent = [headers.join(','), ...csvData].join('\n');
            const csvBlob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(csvBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-tool-risk-assessment-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Generate summary statistics
        function generateSummaryStats() {
            const stats = { critical: 0, high: 0, medium: 0, low: 0 };
            const totalScore = tools.reduce((sum, tool) => sum + calculateScore(tool.scores), 0);
            const avgScore = tools.length > 0 ? (totalScore / tools.length).toFixed(1) : 0;

            tools.forEach(tool => {
                const score = calculateScore(tool.scores);
                const level = getRiskLevel(score);
                stats[level]++;
            });

            return {
                totalTools: tools.length,
                averageScore: avgScore,
                distribution: stats,
                highestRiskTool: tools.length > 0 ? tools.reduce((max, tool) => {
                    const score = calculateScore(tool.scores);
                    const maxScore = calculateScore(max.scores);
                    return score > maxScore ? tool : max;
                }).name : null
            };
        }

        // Update database status indicator
        function updateDBStatus(message, type = 'success') {
            const statusEl = document.getElementById('dbStatus');
            if (statusEl) {
                const colors = {
                    success: '#27ae60',
                    error: '#e74c3c',
                    saving: '#f39c12'
                };
                statusEl.style.color = colors[type];
                statusEl.innerHTML = message;
                
                // Reset to "Database Ready" after 3 seconds for success/error
                if (type !== 'saving') {
                    setTimeout(() => {
                        statusEl.style.color = '#27ae60';
                        statusEl.innerHTML = '💾 Database Ready';
                    }, 3000);
                }
            }
        }

        // Save to JSON database
        function saveToDatabase() {
            updateDBStatus('💾 Saving...', 'saving');
            
            const database = {
                metadata: {
                    version: "1.0",
                    lastUpdated: new Date().toISOString(),
                    totalTools: tools.length,
                    frameworkVersion: "2.0"
                },
                tools: {},
                assessmentHistory: []
            };
            
            tools.forEach(tool => {
                database.tools[tool.id] = {
                    ...tool,
                    assessmentDate: tool.assessmentDate || new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
            });
            
            // Save to localStorage for now (we'll add file system later)
            try {
                localStorage.setItem('aiToolDatabase', JSON.stringify(database));
                console.log('Database saved successfully');
                updateDBStatus('✅ Database Saved', 'success');
            } catch (e) {
                console.warn('Could not save database:', e);
                updateDBStatus('❌ Save Failed', 'error');
            }
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('aiToolRiskData');
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        tools = parsedData;
                    }
                }
            } catch (e) {
                console.warn('Could not load from localStorage:', e);
            }
        }

        // Load from JSON database
        function loadFromDatabase() {
            try {
                const saved = localStorage.getItem('aiToolDatabase');
                if (saved) {
                    // If a database exists in localStorage, use it as the source of truth.
                    const database = JSON.parse(saved);
                    console.log('Database found in localStorage. Loading...');
                    
                    if (database.tools && typeof database.tools === 'object') {
                        tools = Object.values(database.tools);
                    } else if (Array.isArray(database)) {
                        // Support for older, simple array format
                        tools = database;
                    } else {
                        tools = []; // Default to empty if format is unrecognized
                    }
                    
                    tools = tools.filter(tool => tool && tool.name && tool.scores);
                    console.log(`Loaded ${tools.length} tools from localStorage.`);

                } else {
                    // If no database exists, this is the first run.
                    // The 'tools' variable is already populated with the default hardcoded data.
                    // We now save this default data to create the database in localStorage.
                    console.log('No database found. Initializing from default tools and saving.');
                    saveToDatabase();
                }
            } catch (e) {
                console.warn('Could not load or initialize database:', e);
                // In case of error, we don't wipe out the default tools.
            }
        }

        // Add version tracking to tools
        function addVersionToTool(tool) {
            if (!tool.versions) {
                tool.versions = [];
            }
            
            tool.versions.push({
                date: new Date().toISOString(),
                scores: { ...tool.scores },
                riskFactors: JSON.parse(JSON.stringify(tool.riskFactors)),
                usageNote: tool.usageNote ? { ...tool.usageNote } : null
            });
            
            // Keep only last 10 versions
            if (tool.versions.length > 10) {
                tool.versions = tool.versions.slice(-10);
            }
        }

        // Import data functionality
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            let importedTools = [];
                            
                            // Handle different import formats
                            if (importedData.tools && Array.isArray(importedData.tools)) {
                                // Format: { tools: [...] }
                                importedTools = importedData.tools;
                            } else if (importedData.tools && typeof importedData.tools === 'object') {
                                // Format: { tools: { "1": {...}, "2": {...} } }
                                importedTools = Object.values(importedData.tools);
                            } else if (Array.isArray(importedData)) {
                                // Format: [...]
                                importedTools = importedData;
                            } else {
                                alert('Invalid file format. Please select a valid export file.');
                                return;
                            }
                            
                            if (importedTools.length > 0) {
                                if (confirm(`Import ${importedTools.length} tools? This will replace all current data.`)) {
                                    tools = importedTools;
                                    renderTools();
                                    saveToDatabase();
                                    alert(`Successfully imported ${importedTools.length} tools!`);
                                }
                            } else {
                                alert('No tools found in the import file.');
                            }
                        } catch (error) {
                            alert('Error reading file. Please ensure it\'s a valid JSON export.');
                            console.error('Import error:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Add import button to controls
        function addImportButton() {
            const controls = document.querySelector('.controls');
            const importBtn = document.createElement('button');
            importBtn.className = 'export-btn';
            importBtn.innerHTML = '📂 Import Data';
            importBtn.onclick = importData;
            controls.insertBefore(importBtn, controls.children[2]);
        }

        // Bulk operations
        function bulkDeleteByRiskLevel(riskLevel) {
            if (confirm(`Delete all ${riskLevel.toUpperCase()} risk tools? This cannot be undone.`)) {
                tools = tools.filter(tool => {
                    const score = calculateScore(tool.scores);
                    const level = getRiskLevel(score);
                    return level !== riskLevel;
                });
                renderTools();
                saveToDatabase(); // Save to JSON database instead of localStorage
            }
        }

        // Add bulk operation buttons
        function addBulkOperations() {
            const content = document.querySelector('.content');
            const bulkOpsDiv = document.createElement('div');
            bulkOpsDiv.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">🔧 Bulk Operations</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="bulkDeleteByRiskLevel('critical')" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Delete All Critical</button>
                        <button onclick="bulkDeleteByRiskLevel('high')" style="background: #f39c12; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Delete All High Risk</button>
                        <button onclick="duplicateTool()" style="background: #9b59b6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Duplicate Last Tool</button>
                        <button onclick="resetAllData()" style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Reset All Data</button>
                    </div>
                </div>
            `;
            content.insertBefore(bulkOpsDiv, content.firstChild);
        }

        // Duplicate tool functionality
        function duplicateTool() {
            if (tools.length === 0) {
                alert('No tools to duplicate');
                return;
            }
            
            const lastTool = tools[tools.length - 1];
            const newId = Math.max(...tools.map(t => t.id), 0) + 1;
            const duplicatedTool = {
                ...JSON.parse(JSON.stringify(lastTool)),
                id: newId,
                name: lastTool.name + ' (Copy)'
            };
            
            tools.push(duplicatedTool);
            renderTools();
            saveToDatabase(); // Save to JSON database instead of localStorage
        }

        // Reset all data
        function resetAllData() {
            if (confirm('This will delete ALL tools and reset to default data. Are you sure?')) {
                tools = [
                    {
                        id: 1,
                        name: "ChatGPT Free",
                        scores: {
                            dataStorage: 20,
                            trainingUsage: 25,
                            accessControls: 20,
                            complianceRisk: 15,
                            vendorTransparency: 2
                        },
                        riskFactors: [
                            {"label": "Training Data Usage", "detail": "All conversations used for model training by default"},
                            {"label": "Compliance Gaps", "detail": "Not HIPAA compliant, no Business Associate Agreement available"}
                        ],
                        usageNote: {
                            type: "warning",
                            title: "⚠️ If Use Required:",
                            content: "Never input confidential data, customer information, or regulated content."
                        }
                    }
                ];
                renderTools();
                saveToDatabase(); // Save to JSON database instead of localStorage
                alert('Data reset successfully!');
            }
        }

        // Auto-save functionality
        let autoSaveInterval;
        function startAutoSave() {
            autoSaveInterval = setInterval(saveToDatabase, 30000); // Save every 30 seconds to database
        }

        // Modal keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (document.getElementById('toolModal').style.display === 'block') {
                    document.getElementById('toolForm').dispatchEvent(new Event('submit'));
                }
            }
        });

        // Click outside modal to close
        window.onclick = function(event) {
            const modal = document.getElementById('toolModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Real-time score calculation in modal
        function setupRealTimeScoring() {
            const scoreInputs = ['dataStorage', 'trainingUsage', 'accessControls', 'complianceRisk', 'vendorTransparency'];
            const scoreDisplay = document.createElement('div');
            scoreDisplay.id = 'realTimeScore';
            scoreDisplay.style.cssText = 'background: #ecf0f1; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; font-weight: bold;';
            
            document.getElementById('toolForm').appendChild(scoreDisplay);
            
            function updateScore() {
                let total = 0;
                scoreInputs.forEach(inputId => {
                    total += parseInt(document.getElementById(inputId).value) || 0;
                });
                
                const level = getRiskLevel(total);
                const riskInfo = getRiskInfo(level);
                scoreDisplay.innerHTML = `
                    <div>Total Risk Score: <span class="${level}">${total}</span></div>
                    <div style="margin-top: 5px; font-size: 0.9rem;">Risk Level: ${riskInfo.name}</div>
                `;
            }
            
            scoreInputs.forEach(inputId => {
                document.getElementById(inputId).addEventListener('input', updateScore);
            });
            
            updateScore(); // Initial calculation
        }

        // Show category-specific help
        function showCategoryHelp(category) {
            const breakdownDiv = document.getElementById(`${category}-breakdown`);
            const isVisible = breakdownDiv.style.display !== 'none';
            
            // Hide all other breakdowns
            document.querySelectorAll('.category-breakdown').forEach(div => {
                div.style.display = 'none';
            });
            
            if (!isVisible) {
                // Show this breakdown
                const criteria = scoringCriteria[category];
                let html = '';
                
                Object.entries(criteria.subcategories).forEach(([key, subcategory]) => {
                    html += `
                        <div class="subcategory-item">
                            <h5>${subcategory.label}</h5>
                            <ul class="guidance-list">
                                ${subcategory.guidance.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });
                
                breakdownDiv.innerHTML = html;
                breakdownDiv.style.display = 'block';
            }
        }

        // Toggle the main scoring guidance panel
        function toggleScoringGuidance() {
            const panel = document.getElementById('scoringGuidancePanel');
            const button = document.getElementById('toggleGuidance');
            const isVisible = panel.style.display !== 'none';
            
            if (!isVisible) {
                // Show detailed guidance
                let html = '';
                Object.entries(scoringCriteria).forEach(([key, criteria]) => {
                    html += `
                        <div style="margin-bottom: 20px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e0e0e0;">
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">${criteria.label} (Max: ${criteria.max} points)</h4>
                            ${Object.entries(criteria.subcategories).map(([subKey, subcategory]) => `
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: #34495e;">${subcategory.label}</strong>
                                    <ul style="margin: 5px 0 0 20px; font-size: 13px;">
                                        ${subcategory.guidance.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
                
                panel.innerHTML = html;
                panel.style.display = 'block';
                button.textContent = 'Hide Details';
            } else {
                panel.style.display = 'none';
                button.textContent = 'Show Details';
            }
        }

        // Enhanced export with options
        function exportWithOptions() {
            const includeGuidance = confirm('Include detailed scoring guidance in the export?\n\nYes = Full export with scoring criteria\nNo = Basic export with scores only');
            
            const exportData = {
                metadata: {
                    version: "2.0",
                    lastUpdated: new Date().toISOString(),
                    totalTools: tools.length,
                    frameworkVersion: "2.0",
                    includesGuidance: includeGuidance
                },
                tools: includeGuidance ? 
                    tools.map(tool => ({
                        ...tool,
                        scoringGuidance: scoringCriteria
                    })) : 
                    tools,
                ...(includeGuidance && { scoringCriteria })
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai_tools_assessment_${includeGuidance ? 'detailed_' : ''}${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize application
        function init() {
            loadFromDatabase(); // Load from JSON database instead of localStorage
            renderTools();
            addImportButton();
            addBulkOperations();
            setupRealTimeScoring();
            startAutoSave();
            
            // Add event listeners for guidance
            document.getElementById('toggleGuidance').onclick = toggleScoringGuidance;
            
            // Add enhanced export button
            const controls = document.querySelector('.controls');
            const enhancedExportBtn = document.createElement('button');
            enhancedExportBtn.className = 'export-btn';
            enhancedExportBtn.innerHTML = '📋 Export with Options';
            enhancedExportBtn.onclick = exportWithOptions;
            controls.appendChild(enhancedExportBtn);
            
            // Add some helpful tooltips
            addTooltips();
        }

        // Add helpful tooltips
        function addTooltips() {
            const tooltips = {
                'dataStorage': 'Higher scores indicate greater data retention and sharing risks',
                'trainingUsage': 'Higher scores mean your data will likely be used for AI training',
                'accessControls': 'Higher scores indicate weaker enterprise access controls',
                'complianceRisk': 'Higher scores mean greater regulatory compliance risks',
                'vendorTransparency': 'Higher scores indicate less transparency from the vendor'
            };
            
            Object.entries(tooltips).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.title = text;
                    element.style.cursor = 'help';
                }
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);

        // Show database statistics
        function showDatabaseStats() {
            const stats = { critical: 0, high: 0, medium: 0, low: 0 };
            let totalVersions = 0;
            
            tools.forEach(tool => {
                const score = calculateScore(tool.scores);
                const level = getRiskLevel(score);
                stats[level]++;
                if (tool.versions) {
                    totalVersions += tool.versions.length;
                }
            });

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Database Statistics</h2>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #2c3e50;">${tools.length}</div>
                                <div style="color: #7f8c8d;">Total Tools</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;">${stats.critical}</div>
                                <div style="color: #7f8c8d;">Critical Risk</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #f39c12;">${stats.high}</div>
                                <div style="color: #7f8c8d;">High Risk</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #f1c40f;">${stats.medium}</div>
                                <div style="color: #7f8c8d;">Medium Risk</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #27ae60;">${stats.low}</div>
                                <div style="color: #7f8c8d;">Low Risk</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #3498db;">${totalVersions}</div>
                                <div style="color: #7f8c8d;">Total Versions</div>
                            </div>
                        </div>
                        
                        <div style="background: #ecf0f1; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 15px; color: #2c3e50;">Database Info</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem;">
                                <div><strong>Framework Version:</strong> 2.0</div>
                                <div><strong>Database Version:</strong> 1.0</div>
                                <div><strong>Last Updated:</strong> ${new Date().toLocaleString()}</div>
                                <div><strong>Storage:</strong> Local Storage</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="save-btn">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Refresh database functionality
        function refreshDatabase() {
            updateDBStatus('🔄 Refreshing...', 'saving');
            loadFromDatabase();
            renderTools();
            updateDBStatus('✅ Database Refreshed', 'success');
        }

        // Debug database contents
        function debugDatabase() {
            try {
                const saved = localStorage.getItem('aiToolDatabase');
                if (saved) {
                    const database = JSON.parse(saved);
                    console.log('=== DATABASE DEBUG ===');
                    console.log('Raw database:', database);
                    console.log('Database type:', typeof database);
                    console.log('Has tools property:', 'tools' in database);
                    console.log('Tools type:', typeof database.tools);
                    console.log('Tools is array:', Array.isArray(database.tools));
                    console.log('Tools keys:', database.tools ? Object.keys(database.tools) : 'N/A');
                    console.log('Tools count:', database.tools ? Object.keys(database.tools).length : 0);
                    console.log('=====================');
                    
                    // Show in alert for easy viewing
                    alert(`Database Debug:\n- Type: ${typeof database}\n- Has tools: ${'tools' in database}\n- Tools count: ${database.tools ? Object.keys(database.tools).length : 0}\n- Check console for details`);
                } else {
                    alert('No database found in localStorage');
                }
            } catch (e) {
                alert('Error reading database: ' + e.message);
            }
        }
    </script>
</body>
</html>